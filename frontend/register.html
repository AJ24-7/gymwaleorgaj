<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gym Member Registration</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Month button group as grid for compact plan card */
        .month-btn-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 8px;
            margin-bottom: 4px;
            justify-items: center;
        }
        .month-btn {
            background: #f1f8e9;
            color: #1976d2;
            border: 1.5px solid #b2dfdb;
            border-radius: 8px;
            padding: 7px 0;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 90px;
            outline: none;
        }
        .month-btn:hover {
            background: #e3f2fd;
            border-color: #1976d2;
            color: #1976d2;
        }
        .month-btn.active, .month-btn:focus-visible {
            background: linear-gradient(135deg, #1976d2 60%, #1565c0 100%);
            color: #fff;
            border-color: #1976d2;
            box-shadow: 0 2px 8px rgba(25,118,210,0.10);
            transform: scale(1.07);
            z-index: 1;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1976d2, #1565c0);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .gym-info {
            background: #f8f9fa;
            padding: 25px;
            border-bottom: 1px solid #e9ecef;
        }

        .gym-info h2 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .gym-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .gym-detail-item {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #666;
        }

        .special-offer {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 20px;
            margin: 20px;
            border-radius: 12px;
            text-align: center;
            display: none;
        }

        .special-offer.show {
            display: block;
        }

        .form-container {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .plan-selection {
            margin: 25px 0;
        }

        .plans-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .plan-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: visible;
        }

        .plan-card:hover,
        .plan-card.selected {
            border-color: #0cee3d;
            background: #f8f9ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(18, 205, 40, 0.15);
        }

        .plan-card.selected::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 10px;
            right: 15px;
            color: #19d235;
            font-size: 1.2rem;
        }

        .plan-card .discount-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .plan-name {
            font-weight: 700;
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 10px;
        }

        .plan-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1976d2;
            margin-bottom: 10px;
        }

        .plan-features {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
        }

        .submit-btn {
            background: linear-gradient(135deg, #1976d2, #1565c0);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(25, 118, 210, 0.3);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
        }

        .submit-btn.loading .loading {
            display: inline-block;
        }

        .submit-btn.loading .normal-text {
            display: none;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #c62828;
            display: none;
        }

        .success-message {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #4caf50;
            text-align: center;
            display: none;
        }

        .payment-info-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease-out;
        }

        .payment-info-card {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
        }

        .payment-info-header h3 {
            margin: 0 0 8px 0;
            color: #1a365d;
            font-size: 1.5rem;
        }

        .payment-info-header p {
            margin: 0 0 24px 0;
            color: #64748b;
            font-size: 1rem;
        }

        .payment-details {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 12px 0;
        }

        .detail-row .label {
            color: #64748b;
            font-weight: 500;
        }

        .detail-row .value {
            color: #1a365d;
            font-weight: 600;
        }

        .detail-row .amount {
            color: #059669;
            font-size: 1.25rem;
        }

        .payment-redirect-info {
            margin-top: 24px;
        }

        .payment-redirect-info .loader {
            width: 24px;
            height: 24px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        .payment-redirect-info p {
            margin: 0 0 8px 0;
            color: #1a365d;
            font-weight: 500;
        }

        .payment-redirect-info small {
            color: #64748b;
            font-size: 0.875rem;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(30px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .trial-badge {
            background: #ff9800;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .premium-badge {
            background: linear-gradient(135deg, #ffd700, #ffb300);
            color: #333;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .qr-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            color: #1976d2;
        }

        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #1976d2;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            backdrop-filter: blur(5px);
            transition: opacity 0.3s ease;
        }

        .loading-content {
            text-align: center;
            padding: 40px;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #e3f2fd;
            border-top: 4px solid #1976d2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .loading-text {
            color: #1976d2;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .loading-subtext {
            color: #666;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading Registration Form...</div>
            <div class="loading-subtext">Please wait while we prepare everything for you</div>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
              <span style="display:inline-flex;align-items:center;justify-content:center;background:#fff;border-radius:12px;padding:6px;box-shadow:0 2px 8px rgba(25,118,210,0.10);margin-right:12px;">
                <img src="../gymadmin/public/Gym-Wale.png" alt="Gym-Wale Logo" style="height:48px;width:48px;border-radius:8px;transition:transform .2s;">
              </span>
              Gym-Wale
            </h1>
            <p>Complete your membership registration for <span id="headerGymName">this gym</span></p>
        </div>

        <!-- QR Code Info -->
        <div class="qr-info" id="qrInfo">
            <i class="fas fa-qrcode"></i> <span id="qrInfoText">You're registering via QR Code - Quick & Easy!</span>
        </div>

        <!-- Gym Information -->
        <div class="gym-info">
            <h2>
                <img id="gymLogo" src="https://via.placeholder.com/40/1976d2/ffffff?text=GYM" alt="Gym Logo" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover;">
                <span id="gymName">Loading...</span>
            </h2>
            <div class="gym-details" id="gymDetails">
                <!-- Gym details will be loaded here -->
            </div>
        </div>

        <!-- Special Offer -->
        <div class="special-offer" id="specialOffer">
            <h3><i class="fas fa-gift"></i> Special Offer!</h3>
            <p id="offerText"></p>
        </div>

        <!-- Registration Form -->
        <div class="form-container">
            <form id="registrationForm">
                <div class="error-message" id="errorMessage"></div>
                <div class="success-message" id="successMessage"></div>

                <!-- Personal Information -->
                <h3 style="color: #333; margin-bottom: 20px; border-bottom: 2px solid #e9ecef; padding-bottom: 10px;">
                    <i class="fas fa-user"></i> Personal Information
                </h3>

                <div class="form-group">
                    <label for="memberName">Name *</label>
                    <input type="text" id="memberName" name="memberName" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="memberAge">Age *</label>
                        <input type="number" id="memberAge" name="memberAge" min="10" max="100" required>
                    </div>
                    <div class="form-group">
                        <label for="memberGender">Gender *</label>
                        <select id="memberGender" name="memberGender" required>
                            <option value="">Select</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="memberEmail">Email *</label>
                        <input type="email" id="memberEmail" name="memberEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="memberPhone">Phone Number *</label>
                        <input type="tel" id="memberPhone" name="memberPhone" pattern="[0-9]{10}" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="memberAddress">Address *</label>
                    <input type="text" id="memberAddress" name="memberAddress" placeholder="Street, City, State" required>
                </div>

                <div class="form-row">
                    <!-- Monthly plan selection moved to each plan card below -->
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="activityPreference">Activity Preference *</label>
                        <select id="activityPreference" name="activityPreference" required>
                            <option value="">Select Activity</option>
                            <option value="Weight Training">Weight Training</option>
                            <option value="Cardio">Cardio</option>
                            <option value="Yoga">Yoga</option>
                            <option value="CrossFit">CrossFit</option>
                            <option value="Swimming">Swimming</option>
                            <option value="Group Classes">Group Classes</option>
                        </select>
                    </div>
                </div>

                <!-- Membership Plan Selection -->
                <div class="plan-selection">
                    <h3 style="color: #333; margin-bottom: 15px; border-bottom: 2px solid #e9ecef; padding-bottom: 10px;">
                        <i class="fas fa-credit-card"></i> Choose Your Membership Plan
                    </h3>
                    <div class="plans-grid" id="plansGrid">
                        <!-- Plans will be loaded here -->
                    </div>
                </div>

                <!-- Hidden Fields -->
                <input type="hidden" id="planSelected" name="planSelected">
                <input type="hidden" id="monthlyPlan" name="monthlyPlan">
                <input type="hidden" id="gymId" name="gymId">
                <input type="hidden" id="qrToken" name="qrToken">

                <!-- Submit Button -->
                <button type="submit" class="submit-btn" id="submitBtn">
                    <span class="normal-text">
                        <i class="fas fa-user-plus"></i> Complete Registration
                    </span>
                    <span class="loading">
                        <div class="spinner"></div> Processing...
                    </span>
                </button>
            </form>
        </div>
    </div>

    <script>
        class MemberRegistration {
            constructor() {
                this.qrToken = this.getUrlParameter('token');
                this.gymId = this.getUrlParameter('gym');
                this.qrData = null;
                this.gymData = null;
                this.selectedPlan = null;
                
                console.log('MemberRegistration initialized with:', {
                    qrToken: this.qrToken,
                    gymId: this.gymId,
                    url: window.location.href,
                    timestamp: new Date().toISOString()
                });
                
                // Clear any previous gym data from memory and DOM
                this.clearPreviousData();
                
                this.init();
            }

            clearPreviousData() {
                // Clear DOM elements
                document.getElementById('gymName').textContent = 'Loading...';
                document.getElementById('headerGymName').textContent = 'Loading...';
                document.getElementById('gymDetails').innerHTML = '<div style="color:#666;">Loading gym details...</div>';
                document.getElementById('plansGrid').innerHTML = '<div style="color:#666;text-align:center;padding:20px;">Loading membership plans...</div>';
                
                // Clear form fields
                document.getElementById('gymId').value = '';
                document.getElementById('qrToken').value = '';
                
                // Reset logo
                const logoElement = document.getElementById('gymLogo');
                if (logoElement) {
                    logoElement.src = 'https://via.placeholder.com/40/1976d2/ffffff?text=GYM';
                }
                
                console.log('Previous data cleared');
            }

            async init() {
                if (!this.qrToken || !this.gymId) {
                    this.hideLoading();
                    this.showError('Invalid registration link. Please scan the QR code again or contact the gym for assistance.');
                    return;
                }

                console.log('*** STARTING INIT with gymId:', this.gymId, 'qrToken:', this.qrToken, '***');

                try {
                    await this.validateQRCode();
                    console.log('*** AFTER QR VALIDATION, gymId is now:', this.gymId, '***');
                    
                    await this.loadGymData();
                    console.log('*** AFTER GYM DATA LOAD, final gymId:', this.gymId, '***');
                    
                    this.setupForm();
                    this.bindEvents();
                    
                    // Hide loading overlay
                    this.hideLoading();
                    console.log('‚úÖ Registration form loaded successfully!');
                } catch (error) {
                    console.error('‚ùå Initialization error:', error);
                    this.hideLoading();
                    this.showError('Some features could not be loaded, but you can still proceed with registration.');
                }
            }

            hideLoading() {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.style.opacity = '0';
                    setTimeout(() => {
                        loadingOverlay.style.display = 'none';
                    }, 300);
                }
            }

            getUrlParameter(name) {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(name);
            }


            async validateQRCode() {
                try {
                    console.log('üîç Starting QR code validation...');
                    console.log('üìã Gym ID:', this.gymId);
                    console.log('üé´ Token:', this.qrToken);
                    
                    let backendValidation = false;
                    
                    // Try backend validation with better error handling
                    try {
                        const timestamp = new Date().getTime();
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
                        
                        const response = await fetch(`/api/qr-codes/validate/${this.qrToken}?_t=${timestamp}`, {
                            headers: {
                                'Cache-Control': 'no-cache',
                                'Pragma': 'no-cache'
                            },
                            signal: controller.signal
                        }).catch(err => {
                            // Silently handle network errors
                            console.log('‚ÑπÔ∏è Backend QR validation not available (using local validation)');
                            return null;
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (response && response.ok) {
                            const contentType = response.headers.get('content-type');
                            if (contentType && contentType.includes('application/json')) {
                                const data = await response.json();
                                
                                if (data.valid) {
                                    console.log('‚úÖ Backend QR validation successful');
                                    this.qrData = data;
                                    this.gymData = data.gym || {};
                                    
                                    // Update gymId from response
                                    let correctGymId = data.gymId || data.gym?.id || data.qrCode?.gymId || this.gymId;
                                    this.gymId = correctGymId;
                                    console.log('‚úÖ Using gym ID from backend:', this.gymId);
                                    backendValidation = true;
                                }
                            }
                        }
                    } catch (fetchError) {
                        // Silently handle - this is expected when API doesn't exist
                        if (fetchError.name !== 'AbortError') {
                            console.log('‚ÑπÔ∏è Backend validation unavailable, using local mode');
                        }
                    }
                    
                    // Use local validation if backend not available
                    if (!backendValidation) {
                        console.log('üíæ Using local QR code validation...');
                        let foundQRData = null;
                        let foundGymId = null;
                        
                        // Search all gym QR codes in localStorage
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key && key.startsWith('gymQRCodes_')) {
                                const gymId = key.replace('gymQRCodes_', '');
                                const gymQRCodes = JSON.parse(localStorage.getItem(key) || '[]');
                                const qrData = gymQRCodes.find(qr => qr.token === this.qrToken);
                                
                                if (qrData) {
                                    // Check expiry
                                    const now = new Date();
                                    const expiry = new Date(qrData.expiryDate);
                                    if (expiry >= now) {
                                        foundQRData = qrData;
                                        foundGymId = gymId;
                                        console.log('‚úÖ Found valid QR data in localStorage:', foundQRData);
                                        break;
                                    } else {
                                        console.warn('‚ö†Ô∏è Found QR code but it has expired');
                                    }
                                }
                            }
                        }
                        
                        if (foundQRData) {
                            // Use localStorage data
                            this.qrData = {
                                valid: true,
                                qrCode: foundQRData,
                                registrationType: foundQRData.registrationType || 'standard',
                                specialOffer: foundQRData.specialOffer || null
                            };
                            this.gymId = foundGymId;
                            console.log('‚úÖ Successfully loaded from localStorage, gymId:', this.gymId);
                        } else {
                            // Last resort: accept the QR code anyway (for development/demo)
                            console.warn('‚ö†Ô∏è No QR data found in localStorage, using permissive validation');
                            this.qrData = {
                                valid: true,
                                registrationType: 'standard',
                                specialOffer: null,
                                usageLimit: 'unlimited'
                            };
                            // Keep the gymId from URL
                            console.log('‚úÖ Using gymId from URL:', this.gymId);
                        }
                    }

                    // Set hidden form fields
                    document.getElementById('gymId').value = this.gymId;
                    document.getElementById('qrToken').value = this.qrToken;
                    
                    console.log('‚úÖ QR validation complete. GymId:', this.gymId, 'QRData:', this.qrData);

                } catch (error) {
                    console.error('‚ùå QR validation error:', error);
                    // Even on error, try to proceed with registration
                    console.warn('‚ö†Ô∏è Proceeding with registration despite validation error');
                    this.qrData = {
                        valid: true,
                        registrationType: 'standard',
                        specialOffer: null,
                        usageLimit: 'unlimited'
                    };
                    document.getElementById('gymId').value = this.gymId;
                    document.getElementById('qrToken').value = this.qrToken;
                }
            }

            async loadGymData() {
                try {
                    const gymIdToUse = this.gymId || document.getElementById('gymId').value;
                    console.log('üè¢ Loading gym information...');
                    
                    if (!gymIdToUse) {
                        throw new Error('No gym ID available');
                    }
                    
                    let gymDataLoaded = false;
                    
                    // Try to fetch gym data from backend
                    try {
                        const timestamp = new Date().getTime();
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 5000);
                        
                        const response = await fetch(`/api/gyms/${gymIdToUse}?_t=${timestamp}`, {
                            headers: {
                                'Cache-Control': 'no-cache',
                                'Pragma': 'no-cache'
                            },
                            signal: controller.signal
                        }).catch(err => {
                            console.log('‚ÑπÔ∏è Gym API not available (using demo mode)');
                            return null;
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (response && response.ok) {
                            const contentType = response.headers.get('content-type');
                            if (contentType && contentType.includes('application/json')) {
                                const gymData = await response.json();
                                this.gymData = gymData;
                                console.log('‚úÖ Gym data loaded from backend');
                                
                                this.displayGymInfo(gymData);
                                gymDataLoaded = true;
                            }
                        }
                    } catch (fetchError) {
                        if (fetchError.name !== 'AbortError') {
                            console.log('‚ÑπÔ∏è Using demo gym data');
                        }
                    }
                    
                    // Use fallback if backend unavailable
                    if (!gymDataLoaded) {
                        console.log('üíæ Using local gym data...');
                        this.useFallbackGymData(gymIdToUse);
                    }
                    
                    // Always try to load membership plans
                    await this.loadMembershipPlans();
                    
                } catch (error) {
                    console.error('‚ùå Error in loadGymData:', error);
                    this.showWarning('Some gym information could not be loaded. You can still proceed with registration.');
                    // Still try to load membership plans with fallback
                    await this.loadMembershipPlans();
                }
            }

            useFallbackGymData(gymId) {
                console.log('üíæ Checking localStorage for gym data:', gymId);
                
                // Try to get gym data from localStorage (saved by gym admin panel)
                let gymData = null;
                
                // Method 1: Check for gym profile in localStorage
                const storedGymProfile = localStorage.getItem('currentGymProfile');
                if (storedGymProfile) {
                    try {
                        const parsedProfile = JSON.parse(storedGymProfile);
                        if (parsedProfile._id === gymId || parsedProfile.id === gymId) {
                            console.log('‚úÖ Found gym data in localStorage (currentGymProfile)');
                            gymData = parsedProfile;
                        }
                    } catch (e) {
                        console.warn('Failed to parse currentGymProfile:', e);
                    }
                }
                
                // Method 2: Check for gym-specific storage
                if (!gymData) {
                    const gymKey = `gym_${gymId}`;
                    const storedGym = localStorage.getItem(gymKey);
                    if (storedGym) {
                        try {
                            gymData = JSON.parse(storedGym);
                            console.log('‚úÖ Found gym data in localStorage (gym_key)');
                        } catch (e) {
                            console.warn('Failed to parse gym data:', e);
                        }
                    }
                }
                
                // Method 3: Check sessionStorage as fallback
                if (!gymData) {
                    const sessionGym = sessionStorage.getItem('currentGymProfile');
                    if (sessionGym) {
                        try {
                            const parsedSession = JSON.parse(sessionGym);
                            if (parsedSession._id === gymId || parsedSession.id === gymId) {
                                console.log('‚úÖ Found gym data in sessionStorage');
                                gymData = parsedSession;
                            }
                        } catch (e) {
                            console.warn('Failed to parse sessionStorage:', e);
                        }
                    }
                }
                
                // If we found gym data, use it
                if (gymData) {
                    console.log('‚úÖ Using stored gym data:', gymData.gymName || gymData.name);
                    this.gymData = gymData;
                    this.displayGymInfo(gymData);
                    // Update QR info banner
                    this.updateQRInfoBanner('success');
                    return;
                }
                
                // Last resort: Create minimal placeholder gym data
                console.log('‚ö†Ô∏è No gym data found in storage, using placeholder');
                // Update QR info banner to show demo mode
                this.updateQRInfoBanner('demo');
                
                this.gymData = {
                    _id: gymId,
                    gymName: 'Fitness Center',
                    location: { 
                        address: 'Visit gym for complete details',
                        city: 'Your City',
                        state: 'Your State'
                    },
                    contactDetails: { 
                        phone: 'Contact gym',
                        email: 'info@gym.com'
                    },
                    activities: ['Cardio', 'Strength Training', 'Yoga', 'CrossFit', 'Zumba'],
                    membershipPlans: []
                };
                
                this.displayGymInfo(this.gymData);
            }

            updateQRInfoBanner(mode) {
                const qrInfoText = document.getElementById('qrInfoText');
                const qrInfo = document.getElementById('qrInfo');
                
                if (!qrInfoText || !qrInfo) return;
                
                if (mode === 'demo') {
                    qrInfo.style.background = 'linear-gradient(135deg, #ff9800 0%, #f57c00 100%)';
                    qrInfoText.innerHTML = '<i class="fas fa-info-circle"></i> Demo Mode - Sample gym data shown. Registration will work normally!';
                } else if (mode === 'success') {
                    qrInfo.style.background = '#e3f2fd';
                    qrInfoText.innerHTML = '<i class="fas fa-qrcode"></i> You\'re registering via QR Code - Quick & Easy!';
                }
            }

            displayGymInfo(gymData) {
                // Update UI with gym information
                const gymName = gymData.gymName || gymData.name || 'Gym Registration';
                const gymNameElem = document.getElementById('gymName');
                const headerGymNameElem = document.getElementById('headerGymName');
                
                if (gymNameElem) gymNameElem.textContent = gymName;
                if (headerGymNameElem) headerGymNameElem.textContent = gymName;
                
                // Set gym logo
                const logoElement = document.getElementById('gymLogo');
                let logoUrl = gymData.logoUrl || gymData.logo || 'https://via.placeholder.com/40/1976d2/ffffff?text=GYM';
                
                if (logoElement) {
                    logoElement.src = logoUrl;
                    logoElement.alt = `${gymName} Logo`;
                    logoElement.onerror = function() {
                        this.onerror = null;
                        this.src = 'https://via.placeholder.com/40/1976d2/ffffff?text=GYM';
                    };
                }
                
                // Display gym details
                const gymDetails = document.getElementById('gymDetails');
                gymDetails.innerHTML = `
                    <div class="gym-detail-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${gymData.location?.address || gymData.address || 'Address: Contact gym for details'}</span>
                    </div>
                    <div class="gym-detail-item">
                        <i class="fas fa-phone"></i>
                        <span>${gymData.contactDetails?.phone || gymData.phone || 'Phone: Contact gym'}</span>
                    </div>
                    <div class="gym-detail-item">
                        <i class="fas fa-envelope"></i>
                        <span>${gymData.contactDetails?.email || gymData.email || 'Email: Contact gym'}</span>
                    </div>
                `;
                
                // Populate activities dropdown
                this.populateActivities(gymData.activities || []);
                
                console.log('‚úÖ Gym info displayed');
            }

            // Function to populate activities dropdown like in gymadmin
            populateActivities(activities) {
                const activitySelect = document.getElementById('activityPreference');
                
                if (!activitySelect) return;
                
                // Clear existing options
                activitySelect.innerHTML = '<option value="">Select Activity</option>';
                
                if (activities && activities.length > 0) {
                    activities.forEach(activity => {
                        const activityName = typeof activity === 'string' ? activity : (activity.name || activity);
                        if (activityName) {
                            const option = document.createElement('option');
                            option.value = activityName;
                            option.textContent = activityName;
                            activitySelect.appendChild(option);
                        }
                    });
                } else {
                    // Fallback to default activities if none found
                    const defaultActivities = [
                        'Weight Training',
                        'Cardio',
                        'Yoga',
                        'CrossFit',
                        'Swimming',
                        'Group Classes',
                        'Zumba',
                        'Pilates',
                        'General Fitness'
                    ];
                    
                    defaultActivities.forEach(activity => {
                        const option = document.createElement('option');
                        option.value = activity;
                        option.textContent = activity;
                        activitySelect.appendChild(option);
                    });
                }
            }

            async loadMembershipPlans() {
                try {
                    let plans = [];
                    
                    const gymIdToUse = this.gymId || document.getElementById('gymId').value;
                    console.log('üìã Loading membership plans...');
                    
                    // Method 1: Use gym data if already loaded
                    if (this.gymData && this.gymData.membershipPlans && this.gymData.membershipPlans.length > 0) {
                        plans = this.gymData.membershipPlans;
                        console.log('‚úÖ Using membership plans from gym data:', plans.length, 'plans');
                    } 
                    // Method 2: Try to fetch from backend
                    else {
                        try {
                            const timestamp = new Date().getTime();
                            const controller = new AbortController();
                            const timeoutId = setTimeout(() => controller.abort(), 5000);
                            
                            const response = await fetch(`/api/gyms/${gymIdToUse}?_t=${timestamp}`, {
                                headers: {
                                    'Cache-Control': 'no-cache',
                                    'Pragma': 'no-cache'
                                },
                                signal: controller.signal
                            }).catch(err => {
                                console.log('‚ÑπÔ∏è Plans API not available');
                                return null;
                            });
                            
                            clearTimeout(timeoutId);
                            
                            if (response && response.ok) {
                                const contentType = response.headers.get('content-type');
                                if (contentType && contentType.includes('application/json')) {
                                    const gymData = await response.json();
                                    
                                    if (gymData._id === gymIdToUse && gymData.membershipPlans) {
                                        plans = gymData.membershipPlans;
                                        console.log('‚úÖ Loaded', plans.length, 'plans from backend');
                                    }
                                }
                            }
                        } catch (fetchError) {
                            console.log('‚ÑπÔ∏è Using default membership plans');
                        }
                    }
                    
                    // Method 3: Use default plans if none found
                    if (plans.length === 0) {
                        console.log('üíæ Using default membership plans');
                        plans = [
                            {
                                _id: 'basic',
                                name: 'Basic',
                                price: 800,
                                duration: '1 month',
                                benefits: ['Gym Access', 'Group Classes'],
                                description: 'Best for beginners',
                                color: '#38b000',
                                discount: 0
                            },
                            {
                                _id: 'standard',
                                name: 'Standard',
                                price: 1200,
                                duration: '1 month',
                                benefits: ['All Basic Benefits', 'Diet Plan', 'Locker Facility'],
                                description: 'Most Popular',
                                color: '#3a86ff',
                                discount: 10
                            },
                            {
                                _id: 'premium',
                                name: 'Premium',
                                price: 1800,
                                duration: '1 month',
                                benefits: ['All Standard Benefits', 'Personal Trainer', 'Spa & Sauna'],
                                description: 'For serious fitness',
                                color: '#8338ec',
                                discount: 15
                            }
                        ];
                    }

                    console.log('‚úÖ Rendering', plans.length, 'membership plans');
                    this.renderPlans(plans);
                    
                    // Populate plan dropdown
                    this.populatePlanDropdown(plans);

                    // Pre-select default plan if specified
                    if (this.qrData && this.qrData.defaultPlan) {
                        this.selectPlan(this.qrData.defaultPlan);
                    }

                } catch (error) {
                    console.error('Error loading plans:', error);
                    this.showError('Failed to load membership plans');
                }
            }
            
            // Function to populate plan dropdown like in gymadmin
            populatePlanDropdown(plans) {
                const planSelect = document.getElementById('planSelected');
                if (!planSelect) return;
                
                planSelect.innerHTML = '<option value="">Select Plan</option>';
                
                plans.forEach(plan => {
                    const option = document.createElement('option');
                    option.value = plan.name;
                    option.textContent = `${plan.name} - ‚Çπ${plan.price}/${plan.duration || 'month'}`;
                    planSelect.appendChild(option);
                });
                
                // Add event listener for plan selection to update payment amount
                planSelect.addEventListener('change', () => {
                    this.updatePaymentAmount(plans);
                });
            }
            
            // Function to update payment amount based on selected plan and duration
            updatePaymentAmount(plans) {
                const planSelect = document.getElementById('planSelected');
                const monthlyPlanSelect = document.getElementById('monthlyPlan');
                const paymentAmountInput = document.getElementById('paymentAmount');
                const discountInfo = document.getElementById('discountInfo');
                const discountText = document.getElementById('discountText');
                
                if (!planSelect || !monthlyPlanSelect || !paymentAmountInput) return;
                
                const selectedPlanName = planSelect.value;
                const selectedDuration = monthlyPlanSelect.value;
                
                if (selectedPlanName && selectedDuration) {
                    const plan = plans.find(p => p.name === selectedPlanName);
                    if (plan) {
                        const basePrice = plan.price || 0;
                        const duration = parseInt(selectedDuration.split(' ')[0]) || 1;
                        let totalAmount = basePrice * duration;
                        
                        // Apply discount if available
                        let discount = 0;
                        if (plan.discount && plan.discount > 0) {
                            discount = (totalAmount * plan.discount) / 100;
                            totalAmount = totalAmount - discount;
                        }
                        
                        // Apply duration-based discounts
                        if (duration >= 12) {
                            const additionalDiscount = totalAmount * 0.15; // 15% for annual
                            totalAmount = totalAmount - additionalDiscount;
                            discount += additionalDiscount;
                        } else if (duration >= 6) {
                            const additionalDiscount = totalAmount * 0.10; // 10% for 6 months
                            totalAmount = totalAmount - additionalDiscount;
                            discount += additionalDiscount;
                        } else if (duration >= 3) {
                            const additionalDiscount = totalAmount * 0.05; // 5% for 3 months
                            totalAmount = totalAmount - additionalDiscount;
                            discount += additionalDiscount;
                        }
                        
                        paymentAmountInput.value = Math.round(totalAmount);
                        
                        // Show discount information
                        if (discount > 0 && discountInfo && discountText) {
                            discountInfo.style.display = 'block';
                            discountInfo.style.backgroundColor = '#e8f5e8';
                            discountInfo.style.color = '#2e7d32';
                            discountText.textContent = `Discount applied: ‚Çπ${Math.round(discount)} saved!`;
                        } else if (discountInfo) {
                            discountInfo.style.display = 'none';
                        }
                    }
                } else {
                    paymentAmountInput.value = '';
                    if (discountInfo) {
                        discountInfo.style.display = 'none';
                    }
                }
            }

            renderPlans(plans) {
                const plansGrid = document.getElementById('plansGrid');
                let badge = '';
                if (this.qrData && this.qrData.registrationType === 'trial') {
                    badge = '<span class="trial-badge">3-Day Trial</span>';
                } else if (this.qrData && this.qrData.registrationType === 'premium') {
                    badge = '<span class="premium-badge">Premium Access</span>';
                }

                // Month options
                const monthOptions = [
                    { value: '1', label: '1 Month' },
                    { value: '3', label: '3 Months' },
                    { value: '6', label: '6 Months' },
                    { value: '12', label: '12 Months' }
                ];

                plansGrid.innerHTML = plans.map((plan, idx) => {
                    const planId = plan._id || plan.name;
                    const planColor = plan.color || '#1976d2';
                    const planPrice = plan.price || 0;
                    const planBenefits = plan.benefits || ['Standard features'];
                    const planNote = plan.note || '';
                    const planDiscount = plan.discount || 0;
                    // Discount months: can be array, number, or object {min:6} for 'on or above'
                    let discountMonths = [];
                    let discountMin = null;
                    if (Array.isArray(plan.discountMonths)) {
                        discountMonths = plan.discountMonths.map(Number);
                    } else if (typeof plan.discountMonths === 'object' && plan.discountMonths !== null && plan.discountMonths.min) {
                        discountMin = Number(plan.discountMonths.min);
                    } else if (typeof plan.discountMonths === 'number' && plan.discountMonths > 0) {
                        discountMin = plan.discountMonths;
                    }
                    let discountBadge = '';
                    if (planDiscount > 0 && (discountMonths.length > 0 || discountMin)) {
                        discountBadge = `<div class="discount-badge">${planDiscount}%</div>`;
                    }
                    // Unique select id for each plan
                    const selectId = `monthlyPlan_${idx}`;
                    // Payment and discount display area
                    const paymentId = `paymentAmount_${idx}`;
                    const discountId = `discountInfo_${idx}`;
                    // Month options as buttons (no inline style)
                    const monthBtnGroup = monthOptions.map(opt =>
                        `<button type="button" class="month-btn" data-plan-idx="${idx}" data-months="${opt.value}">${opt.label}</button>`
                    ).join('');
                    // Icon
                    let iconHtml = '';
                    if (plan.icon) {
                        iconHtml = `<i class="fa-solid ${plan.icon}" style="margin-right:7px;color:${planColor};font-size:1.2em;"></i>`;
                    }
                    // Discount months text
                    let discountMonthsText = '';
                    if (planDiscount > 0 && discountMin) {
                        discountMonthsText = `<div style=\"font-size:0.92em;color:#1976d2;margin:4px 0 0 0;\">Discount applies for: <b>${discountMin}+ months</b></div>`;
                    } else if (planDiscount > 0 && discountMonths.length > 0) {
                        discountMonthsText = `<div style=\"font-size:0.92em;color:#1976d2;margin:4px 0 0 0;\">Discount applies for: <b>${discountMonths.join(', ')} month${discountMonths.length>1?'s':''}</b></div>`;
                    }
                    return `
                        <div class="plan-card" data-plan="${planId}" data-plan-name="${plan.name}" style="border-color: ${planColor}20; position: relative;">
                            ${discountBadge}
                            <div class="plan-name" style="color: ${planColor};display:flex;align-items:center;justify-content:space-between;">
                                <span class="plan-title">${iconHtml}${plan.name}${badge}</span>
                                <span style="font-size:1.1rem;font-weight:500;background:#e3f2fd;color:${planColor};border-radius:6px;padding:4px 10px;">‚Çπ${planPrice}/mo</span>
                            </div>
                            <div class="plan-features">${planBenefits.map(b=>`<span style='margin-right:7px;'>‚Ä¢ ${b}</span>`).join('')}</div>
                            ${planNote ? `<div style=\"font-size: 0.8rem; color: #666; margin-top: 8px; font-style: italic;\">${planNote}</div>` : ''}
                            ${discountMonthsText}
                            <div style="margin: 14px 0 10px 0;">
                                <span style="font-weight:600;color:#333;">Select Duration:</span>
                                <div class="month-btn-group" data-plan-idx="${idx}">${monthBtnGroup}</div>
                            </div>
                            <div id="${paymentId}" class="plan-price" style="color:${planColor};font-size:1.2rem;margin-bottom:6px;">‚Çπ0</div>
                            <div id="${discountId}" style="font-size:0.95em;color:#2e7d32;display:none;"></div>
                        </div>
                    `;
                }).join('');

                // Add event listeners for each month button
                document.querySelectorAll('.month-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const idx = parseInt(btn.getAttribute('data-plan-idx'));
                        const plan = plans[idx];
                        const months = parseInt(btn.getAttribute('data-months'));
                        const paymentId = `paymentAmount_${idx}`;
                        const discountId = `discountInfo_${idx}`;
                        // Remove active from all buttons in this group
                        document.querySelectorAll(`.month-btn[data-plan-idx="${idx}"]`).forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        // Update the hidden monthlyPlan field
                        document.getElementById('monthlyPlan').value = months;
                        
                        let totalAmount = 0;
                        let discount = 0;
                        if (plan && months) {
                            totalAmount = plan.price * months;
                            // Only apply plan discount if this month is eligible
                            let discountMonths = [];
                            let discountMin = null;
                            if (Array.isArray(plan.discountMonths)) {
                                discountMonths = plan.discountMonths.map(Number);
                            } else if (typeof plan.discountMonths === 'object' && plan.discountMonths !== null && plan.discountMonths.min) {
                                discountMin = Number(plan.discountMonths.min);
                            } else if (typeof plan.discountMonths === 'number' && plan.discountMonths > 0) {
                                discountMin = plan.discountMonths;
                            }
                            if (plan.discount && plan.discount > 0) {
                                if (discountMin && months >= discountMin) {
                                    discount += (totalAmount * plan.discount) / 100;
                                } else if (discountMonths.length > 0 && discountMonths.includes(months)) {
                                    discount += (totalAmount * plan.discount) / 100;
                                }
                            }
                            totalAmount = totalAmount - discount;
                        }
                        // Update payment and discount display
                        document.getElementById(paymentId).textContent = `‚Çπ${totalAmount > 0 ? Math.round(totalAmount) : 0}`;
                        if (discount > 0) {
                            document.getElementById(discountId).style.display = 'block';
                            document.getElementById(discountId).textContent = `Discount applied: ‚Çπ${Math.round(discount)} saved!`;
                        } else {
                            document.getElementById(discountId).style.display = 'none';
                        }
                    });
                });
            }

            setupForm() {
                // Add click handlers to plan cards
                document.querySelectorAll('.plan-card').forEach(card => {
                    card.addEventListener('click', () => {
                        const planId = card.getAttribute('data-plan');
                        this.selectPlan(planId);
                    });
                });
                
                // Add event listener for monthly plan changes to update payment
                const monthlyPlanSelect = document.getElementById('monthlyPlan');
                if (monthlyPlanSelect) {
                    monthlyPlanSelect.addEventListener('change', () => {
                        // Get current plans and update payment amount
                        if (this.gymData && this.gymData.membershipPlans) {
                            this.updatePaymentAmount(this.gymData.membershipPlans);
                        }
                    });
                }
                
                // Show special offer if available
                if (this.qrData && this.qrData.specialOffer) {
                    document.getElementById('offerText').textContent = this.qrData.specialOffer;
                    document.getElementById('specialOffer').classList.add('show');
                }
            }

            selectPlan(planId) {
                // Remove previous selection
                document.querySelectorAll('.plan-card').forEach(card => {
                    card.classList.remove('selected');
                });

                // Select new plan
                const selectedCard = document.querySelector(`[data-plan="${planId}"]`);
                if (selectedCard) {
                    selectedCard.classList.add('selected');
                    this.selectedPlan = planId;
                    document.getElementById('planSelected').value = planId;
                    
                    // Update payment amount if monthly plan is also selected
                    if (this.gymData && this.gymData.membershipPlans) {
                        this.updatePaymentAmount(this.gymData.membershipPlans);
                    }
                }
            }

            bindEvents() {
                document.getElementById('registrationForm').addEventListener('submit', (e) => {
                    this.handleSubmit(e);
                });
            }

            async handleSubmit(e) {
                e.preventDefault();

                if (!this.selectedPlan) {
                    this.showError('Please select a membership plan');
                    return;
                }

                const submitBtn = document.getElementById('submitBtn');
                submitBtn.classList.add('loading');
                submitBtn.disabled = true;

                try {
                    const formData = new FormData(e.target);
                    const registrationData = Object.fromEntries(formData.entries());

                    // Ensure we use the correct gymId
                    const correctGymId = this.gymId || document.getElementById('gymId').value;
                    registrationData.gymId = correctGymId;

                    // Add QR-specific data
                    registrationData.registrationType = this.qrData.registrationType;
                    registrationData.specialOffer = this.qrData.specialOffer;
                    
                    // Add QR token only if it exists and is valid
                    if (this.qrToken && this.qrToken !== 'undefined' && this.qrToken !== 'null') {
                        registrationData.qrToken = this.qrToken;
                    } else {
                        console.log('No valid QR token - proceeding with direct registration');
                    }

                    console.log('Submitting registration for gym:', correctGymId, 'with data:', registrationData);

                    // Choose endpoint based on QR token validity
                    let endpoint = '/api/register-via-qr';
                    if (!this.qrToken || this.qrToken === 'undefined' || this.qrToken === 'null') {
                        endpoint = '/api/register-direct';
                        console.log('Using direct registration endpoint (no QR token)');
                        // Remove QR-specific fields for direct registration
                        delete registrationData.qrToken;
                        delete registrationData.specialOffer;
                    }

                    // Submit registration
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(registrationData)
                    });

                    const result = await response.json();

                    // Handle cash validation response (202 status)
                    if (response.status === 202 && result.requiresCashValidation) {
                        this.showCashValidationSuccess(result);
                        return;
                    }

                    if (!response.ok) {
                        throw new Error(result.message || 'Registration failed');
                    }

                    this.showSuccess('Registration successful! Welcome to the gym family!');
                    
                    // Handle different next steps based on registration type
                    if (result.nextSteps) {
                        if (result.nextSteps.action === 'payment_required') {
                            // Show payment options
                            this.showPaymentOptions(result.nextSteps.paymentOptions);
                            
                            // Redirect to payment gateway after a short delay
                            setTimeout(() => {
                                if (result.nextSteps.redirectUrl) {
                                    // Get selected duration and plan details
                                    const selectedMonthBtn = document.querySelector('.month-btn.active');
                                    const selectedDuration = selectedMonthBtn ? selectedMonthBtn.getAttribute('data-months') : '1';
                                    
                                    // Get the actual plan name and discounted amount
                                    const selectedPlanCard = document.querySelector('.plan-card.selected');
                                    let planName = result.nextSteps.paymentOptions.planName;
                                    let finalAmount = result.nextSteps.paymentOptions.amount;
                                    
                                    if (selectedPlanCard) {
                                        // Get plan name from data attribute first, then fallback to title element
                                        planName = selectedPlanCard.getAttribute('data-plan-name') || 
                                                 selectedPlanCard.querySelector('.plan-title')?.textContent?.replace(/[^a-zA-Z\s]/g, '').trim() ||
                                                 planName;
                                        
                                        // Get the discounted amount from the plan display
                                        if (selectedMonthBtn) {
                                            const planIdx = selectedMonthBtn.getAttribute('data-plan-idx');
                                            const paymentAmountElement = document.getElementById(`paymentAmount_${planIdx}`);
                                            if (paymentAmountElement) {
                                                const displayedAmount = paymentAmountElement.textContent.replace(/[‚Çπ,]/g, '');
                                                if (displayedAmount && !isNaN(parseFloat(displayedAmount))) {
                                                    finalAmount = parseFloat(displayedAmount);
                                                }
                                            }
                                        }
                                    }
                                    
                                    const paymentUrl = `/frontend/payment-gateway.html?member=${result.nextSteps.paymentOptions.memberId}&planName=${encodeURIComponent(planName)}&amount=${finalAmount}&duration=${selectedDuration}&username=${encodeURIComponent(registrationData.memberName || 'Member')}&email=${encodeURIComponent(registrationData.memberEmail || '')}&phone=${encodeURIComponent(registrationData.memberPhone || '')}&gymId=${correctGymId}`;
                                    console.log('Redirecting to payment gateway:', paymentUrl);
                                    window.location.href = paymentUrl;
                                } else if (result.nextSteps.paymentUrl) {
                                    window.location.href = result.nextSteps.paymentUrl;
                                }
                            }, 3000);
                        } else {
                            // For trial or other types, redirect to completion page
                            setTimeout(() => {
                                if (result.nextSteps.redirectUrl) {
                                    window.location.href = result.nextSteps.redirectUrl;
                                } else {
                                    window.location.href = '/registration-complete';
                                }
                            }, 2000);
                        }
                    } else {
                        // Fallback redirect
                        setTimeout(() => {
                            window.location.href = '/registration-complete';
                        }, 2000);
                    }

                } catch (error) {
                    console.error('Registration error:', error);
                    this.showError(error.message || 'Registration failed. Please try again.');
                } finally {
                    submitBtn.classList.remove('loading');
                    submitBtn.disabled = false;
                }
            }

            showError(message) {
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                document.getElementById('successMessage').style.display = 'none';
                
                // Scroll to error
                errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            showWarning(message) {
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = `‚ö†Ô∏è ${message}`;
                errorDiv.style.display = 'block';
                errorDiv.style.backgroundColor = '#fff3cd';
                errorDiv.style.color = '#856404';
                errorDiv.style.borderColor = '#ffeaa7';
                document.getElementById('successMessage').style.display = 'none';
                
                // Scroll to warning
                errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            showPaymentOptions(paymentOptions) {
                if (!paymentOptions) return;
                
                // Get selected plan details and duration
                const selectedPlanCard = document.querySelector('.plan-card.selected');
                const selectedMonthBtn = document.querySelector('.month-btn.active');
                
                let selectedPlanName = 'Membership Plan';
                let selectedDuration = '1';
                let finalAmount = paymentOptions.amount || 0;
                
                if (selectedPlanCard) {
                    // Get plan name from data attribute
                    selectedPlanName = selectedPlanCard.getAttribute('data-plan-name') || 
                                     selectedPlanCard.querySelector('.plan-title')?.textContent?.replace(/[^a-zA-Z\s]/g, '').trim() ||
                                     'Membership Plan';
                }
                
                if (selectedMonthBtn) {
                    selectedDuration = selectedMonthBtn.getAttribute('data-months') || '1';
                    
                    // Get the discounted amount from the selected plan's display
                    const planIdx = selectedMonthBtn.getAttribute('data-plan-idx');
                    const paymentAmountElement = document.getElementById(`paymentAmount_${planIdx}`);
                    if (paymentAmountElement) {
                        const displayedAmount = paymentAmountElement.textContent.replace(/[‚Çπ,]/g, '');
                        if (displayedAmount && !isNaN(parseFloat(displayedAmount))) {
                            finalAmount = parseFloat(displayedAmount);
                        }
                    }
                }
                
                const durationText = selectedDuration === '1' ? '1 Month' : 
                                  selectedDuration === '3' ? '3 Months' : 
                                  selectedDuration === '6' ? '6 Months' : 
                                  selectedDuration === '12' ? '12 Months' : `${selectedDuration} Month(s)`;
                
                // Create payment info overlay
                const paymentOverlay = document.createElement('div');
                paymentOverlay.className = 'payment-info-overlay';
                paymentOverlay.innerHTML = `
                    <div class="payment-info-card">
                        <div class="payment-info-header">
                            <h3>üí≥ Payment Required</h3>
                            <p>Complete your membership registration</p>
                        </div>
                        <div class="payment-details">
                            <div class="detail-row">
                                <span class="label">Plan:</span>
                                <span class="value">${selectedPlanName}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Duration:</span>
                                <span class="value">${durationText}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Amount:</span>
                                <span class="value amount">‚Çπ${Math.round(finalAmount)}</span>
                            </div>
                        </div>
                        <div class="payment-redirect-info">
                            <div class="loader"></div>
                            <p>Redirecting to payment gateway...</p>
                            <small>You will be redirected automatically in 3 seconds</small>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(paymentOverlay);
                
                // Remove overlay after redirect
                setTimeout(() => {
                    if (paymentOverlay.parentNode) {
                        paymentOverlay.parentNode.removeChild(paymentOverlay);
                    }
                }, 4000);
            }

            showSuccess(message) {
                const successDiv = document.getElementById('successMessage');
                successDiv.innerHTML = `
                    <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                    <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 5px;">Success!</div>
                    <div>${message}</div>
                `;
                successDiv.style.display = 'block';
                document.getElementById('errorMessage').style.display = 'none';
                
                // Scroll to success
                successDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            showCashValidationSuccess(result) {
                const successDiv = document.getElementById('successMessage');
                successDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #4caf50, #2e7d32); color: white; border-radius: 15px; margin: 20px 0;">
                        <i class="fas fa-money-bill-wave" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <div style="font-size: 1.3rem; font-weight: 600; margin-bottom: 10px;">Cash Validation Created!</div>
                        <div style="margin-bottom: 20px;">Please provide this validation code to the gym admin for payment confirmation.</div>
                        
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin: 20px 0;">
                            <div style="font-size: 0.9rem; margin-bottom: 5px;">VALIDATION CODE</div>
                            <div style="font-size: 2.2rem; font-weight: bold; letter-spacing: 3px; color: #ffeb3b;">${result.validationCode}</div>
                        </div>
                        
                        <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 15px;">
                            <div class="countdown-display">‚è∞ This code expires in 2 minutes</div>
                            <div>üì± Show this to the gym admin to confirm your cash payment</div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 20px;">
                            <button onclick="navigator.share ? navigator.share({title: 'Gym Validation Code', text: 'Validation Code: ${result.validationCode}'}) : navigator.clipboard.writeText('${result.validationCode}')" 
                                    style="background: #fff; color: #2e7d32; border: none; padding: 10px 20px; border-radius: 25px; font-weight: 600; cursor: pointer;">
                                <i class="fas fa-copy"></i> Copy Code
                            </button>
                            <button onclick="window.print()" 
                                    style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 10px 20px; border-radius: 25px; font-weight: 600; cursor: pointer;">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </div>
                    </div>
                `;
                successDiv.style.display = 'block';
                document.getElementById('errorMessage').style.display = 'none';
                
                // Scroll to success
                successDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Auto-refresh validation code display with countdown
                this.startValidationCountdown(result.validationCode, result.expiresAt);
            }

            startValidationCountdown(validationCode, expiresAt) {
                const expiryTime = new Date(expiresAt).getTime();
                
                const countdownTimer = setInterval(() => {
                    const now = new Date().getTime();
                    const timeLeft = expiryTime - now;
                    
                    if (timeLeft <= 0) {
                        clearInterval(countdownTimer);
                        // Show expired message
                        const successDiv = document.getElementById('successMessage');
                        if (successDiv && successDiv.innerHTML.includes(validationCode)) {
                            successDiv.innerHTML = `
                                <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #f44336, #c62828); color: white; border-radius: 15px; margin: 20px 0;">
                                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 15px;"></i>
                                    <div style="font-size: 1.3rem; font-weight: 600; margin-bottom: 10px;">Validation Code Expired</div>
                                    <div style="margin-bottom: 20px;">The validation code has expired. Please register again to get a new code.</div>
                                    <button onclick="window.location.reload()" 
                                            style="background: #fff; color: #c62828; border: none; padding: 12px 30px; border-radius: 25px; font-weight: 600; cursor: pointer;">
                                        <i class="fas fa-redo"></i> Register Again
                                    </button>
                                </div>
                            `;
                        }
                        return;
                    }
                    
                    const minutes = Math.floor(timeLeft / 60000);
                    const seconds = Math.floor((timeLeft % 60000) / 1000);
                    
                    // Update countdown display if still visible
                    const countdownElement = successDiv.querySelector('.countdown-display');
                    if (countdownElement) {
                        countdownElement.textContent = `‚è∞ Expires in ${minutes}:${seconds.toString().padStart(2, '0')}`;
                    }
                }, 1000);
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new MemberRegistration();
        });
    </script>
</body>
</html>
