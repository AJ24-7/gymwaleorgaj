<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gym Member Registration</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1976d2, #1565c0);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .gym-info {
            background: #f8f9fa;
            padding: 25px;
            border-bottom: 1px solid #e9ecef;
        }

        .gym-info h2 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .gym-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .gym-detail-item {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #666;
        }

        .special-offer {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 20px;
            margin: 20px;
            border-radius: 12px;
            text-align: center;
            display: none;
        }

        .special-offer.show {
            display: block;
        }

        .form-container {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .plan-selection {
            margin: 25px 0;
        }

        .plans-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .plan-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: visible;
        }

        .plan-card:hover,
        .plan-card.selected {
            border-color: #1976d2;
            background: #f8f9ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.15);
        }

        .plan-card.selected::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 10px;
            right: 15px;
            color: #1976d2;
            font-size: 1.2rem;
        }

        .plan-card .discount-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .plan-name {
            font-weight: 700;
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 10px;
        }

        .plan-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1976d2;
            margin-bottom: 10px;
        }

        .plan-features {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
        }

        .submit-btn {
            background: linear-gradient(135deg, #1976d2, #1565c0);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(25, 118, 210, 0.3);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
        }

        .submit-btn.loading .loading {
            display: inline-block;
        }

        .submit-btn.loading .normal-text {
            display: none;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #c62828;
            display: none;
        }

        .success-message {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #4caf50;
            text-align: center;
            display: none;
        }

        .trial-badge {
            background: #ff9800;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .premium-badge {
            background: linear-gradient(135deg, #ffd700, #ffb300);
            color: #333;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .qr-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            color: #1976d2;
        }

        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #1976d2;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-dumbbell"></i> Welcome to Gym-Wala</h1>
            <p>Complete your membership registration for <span id="headerGymName">this gym</span></p>
        </div>

        <!-- QR Code Info -->
        <div class="qr-info">
            <i class="fas fa-qrcode"></i> You're registering via QR Code - Quick & Easy!
        </div>

        <!-- Gym Information -->
        <div class="gym-info">
            <h2>
                <img id="gymLogo" src="https://via.placeholder.com/40/1976d2/ffffff?text=GYM" alt="Gym Logo" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover;">
                <span id="gymName">Loading...</span>
            </h2>
            <div class="gym-details" id="gymDetails">
                <!-- Gym details will be loaded here -->
            </div>
        </div>

        <!-- Special Offer -->
        <div class="special-offer" id="specialOffer">
            <h3><i class="fas fa-gift"></i> Special Offer!</h3>
            <p id="offerText"></p>
        </div>

        <!-- Registration Form -->
        <div class="form-container">
            <form id="registrationForm">
                <div class="error-message" id="errorMessage"></div>
                <div class="success-message" id="successMessage"></div>

                <!-- Personal Information -->
                <h3 style="color: #333; margin-bottom: 20px; border-bottom: 2px solid #e9ecef; padding-bottom: 10px;">
                    <i class="fas fa-user"></i> Personal Information
                </h3>

                <div class="form-group">
                    <label for="memberName">Name *</label>
                    <input type="text" id="memberName" name="memberName" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="memberAge">Age *</label>
                        <input type="number" id="memberAge" name="memberAge" min="10" max="100" required>
                    </div>
                    <div class="form-group">
                        <label for="memberGender">Gender *</label>
                        <select id="memberGender" name="memberGender" required>
                            <option value="">Select</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="memberEmail">Email *</label>
                        <input type="email" id="memberEmail" name="memberEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="memberPhone">Phone Number *</label>
                        <input type="tel" id="memberPhone" name="memberPhone" pattern="[0-9]{10}" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="memberAddress">Address *</label>
                    <input type="text" id="memberAddress" name="memberAddress" placeholder="Street, City, State" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="paymentMode">Payment Mode *</label>
                        <select id="paymentMode" name="paymentMode" required>
                            <option value="">Select</option>
                            <option value="Cash">Cash</option>
                            <option value="Card">Card</option>
                            <option value="UPI">UPI</option>
                            <option value="Online">Online</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="monthlyPlan">Monthly Plan *</label>
                        <select id="monthlyPlan" name="monthlyPlan" required>
                            <option value="">Select</option>
                            <option value="1 Month">1 Month</option>
                            <option value="3 Months">3 Months</option>
                            <option value="6 Months">6 Months</option>
                            <option value="12 Months">12 Months</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="paymentAmount">Payment Amount *</label>
                        <input type="number" id="paymentAmount" name="paymentAmount" min="0" required>
                        <div id="discountInfo" style="margin-top: 8px; padding: 8px; border-radius: 4px; font-size: 0.9em; display: none;">
                            <i class="fas fa-tag"></i> <span id="discountText">No discount applied</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="activityPreference">Activity Preference *</label>
                        <select id="activityPreference" name="activityPreference" required>
                            <option value="">Select Activity</option>
                            <option value="Weight Training">Weight Training</option>
                            <option value="Cardio">Cardio</option>
                            <option value="Yoga">Yoga</option>
                            <option value="CrossFit">CrossFit</option>
                            <option value="Swimming">Swimming</option>
                            <option value="Group Classes">Group Classes</option>
                        </select>
                    </div>
                </div>

                <!-- Membership Plan Selection -->
                <div class="plan-selection">
                    <h3 style="color: #333; margin-bottom: 15px; border-bottom: 2px solid #e9ecef; padding-bottom: 10px;">
                        <i class="fas fa-credit-card"></i> Choose Your Membership Plan
                    </h3>
                    <div class="plans-grid" id="plansGrid">
                        <!-- Plans will be loaded here -->
                    </div>
                </div>

                <!-- Hidden Fields -->
                <input type="hidden" id="planSelected" name="planSelected">
                <input type="hidden" id="gymId" name="gymId">
                <input type="hidden" id="qrToken" name="qrToken">

                <!-- Submit Button -->
                <button type="submit" class="submit-btn" id="submitBtn">
                    <span class="normal-text">
                        <i class="fas fa-user-plus"></i> Complete Registration
                    </span>
                    <span class="loading">
                        <div class="spinner"></div> Processing...
                    </span>
                </button>
            </form>
        </div>
    </div>

    <script>
        class MemberRegistration {
            constructor() {
                this.qrToken = this.getUrlParameter('token');
                this.gymId = this.getUrlParameter('gym');
                this.qrData = null;
                this.gymData = null;
                this.selectedPlan = null;
                
                this.init();
            }

            async init() {
                if (!this.qrToken || !this.gymId) {
                    this.showError('Invalid registration link. Please contact the gym for assistance.');
                    return;
                }

                try {
                    await this.validateQRCode();
                    await this.loadGymData();
                    this.setupForm();
                    this.bindEvents();
                } catch (error) {
                    console.error('Initialization error:', error);
                    this.showError('Failed to load registration form. Please try again.');
                }
            }

            getUrlParameter(name) {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(name);
            }

            async validateQRCode() {
                try {
                    const response = await fetch(`/api/qr-codes/validate/${this.qrToken}`);
                    const data = await response.json();

                    if (!response.ok || !data.valid) {
                        throw new Error(data.message || 'Invalid QR code');
                    }

                    this.qrData = data;
                    this.gymData = data.gym;

                    // Set hidden form fields
                    document.getElementById('gymId').value = this.gymData.id;
                    document.getElementById('qrToken').value = this.qrToken;

                } catch (error) {
                    console.error('QR validation error:', error);
                    throw new Error('This QR code is invalid, expired, or has reached its usage limit.');
                }
            }

            async loadGymData() {
                try {
                    // Fetch gym data (includes membership plans and activities)
                    const response = await fetch(`/api/gyms/${this.gymId}`);
                    
                    if (response.ok) {
                        const gymData = await response.json();
                        console.log('Gym data loaded:', gymData);
                        
                        // Store gym data
                        this.gymData = gymData;
                        
                        // Set gym name
                        document.getElementById('gymName').textContent = gymData.name;
                        document.getElementById('headerGymName').textContent = gymData.name;
                        
                        // Set gym logo if available
                        const logoElement = document.getElementById('gymLogo');
                        if (gymData.logo && logoElement) {
                            logoElement.src = gymData.logo;
                            logoElement.alt = `${gymData.name} Logo`;
                        }
                        
                        // Display gym details
                        const gymDetails = document.getElementById('gymDetails');
                        gymDetails.innerHTML = `
                            <div class="gym-detail-item">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${gymData.location?.address || gymData.address || 'Address not available'}</span>
                            </div>
                            <div class="gym-detail-item">
                                <i class="fas fa-phone"></i>
                                <span>${gymData.contactDetails?.phone || gymData.phone || 'Phone not available'}</span>
                            </div>
                            <div class="gym-detail-item">
                                <i class="fas fa-envelope"></i>
                                <span>${gymData.contactDetails?.email || gymData.email || 'Email not available'}</span>
                            </div>
                        `;
                        
                        // Populate activities dropdown
                        this.populateActivities(gymData.activities || []);
                        
                        // Load membership plans
                        await this.loadMembershipPlans();
                        
                    } else {
                        console.error('Failed to fetch gym data:', response.status);
                        document.getElementById('gymName').textContent = 'Unknown Gym';
                        document.getElementById('headerGymName').textContent = 'Unknown Gym';
                    }
                } catch (error) {
                    console.error('Error loading gym data:', error);
                    document.getElementById('gymName').textContent = 'Unknown Gym';
                    document.getElementById('headerGymName').textContent = 'Unknown Gym';
                }
            }

            // Function to populate activities dropdown like in gymadmin
            populateActivities(activities) {
                const activitySelect = document.getElementById('activityPreference');
                
                if (!activitySelect) return;
                
                // Clear existing options
                activitySelect.innerHTML = '<option value="">Select Activity</option>';
                
                if (activities && activities.length > 0) {
                    activities.forEach(activity => {
                        const activityName = typeof activity === 'string' ? activity : (activity.name || activity);
                        if (activityName) {
                            const option = document.createElement('option');
                            option.value = activityName;
                            option.textContent = activityName;
                            activitySelect.appendChild(option);
                        }
                    });
                } else {
                    // Fallback to default activities if none found
                    const defaultActivities = [
                        'Weight Training',
                        'Cardio',
                        'Yoga',
                        'CrossFit',
                        'Swimming',
                        'Group Classes',
                        'Zumba',
                        'Pilates',
                        'General Fitness'
                    ];
                    
                    defaultActivities.forEach(activity => {
                        const option = document.createElement('option');
                        option.value = activity;
                        option.textContent = activity;
                        activitySelect.appendChild(option);
                    });
                }
            }

            async loadMembershipPlans() {
                try {
                    let plans = [];
                    
                    // Use gym data if already available, otherwise fetch it
                    if (this.gymData && this.gymData.membershipPlans) {
                        plans = this.gymData.membershipPlans;
                    } else {
                        // Fetch gym data to get membership plans
                        const response = await fetch(`/api/gyms/${this.gymId}`);
                        if (response.ok) {
                            const gymData = await response.json();
                            plans = gymData.membershipPlans || [];
                            console.log('Loaded membership plans from gym data:', plans);
                        } else {
                            console.error('Failed to fetch gym data:', response.status);
                        }
                    }
                    
                    // If no plans from backend, use fallback
                    if (plans.length === 0) {
                        plans = [
                            {
                                _id: 'basic',
                                name: 'Basic',
                                price: 800,
                                duration: '1 month',
                                benefits: ['Gym Access', 'Group Classes'],
                                description: 'Best for beginners',
                                color: '#38b000',
                                discount: 0
                            },
                            {
                                _id: 'standard',
                                name: 'Standard',
                                price: 1200,
                                duration: '1 month',
                                benefits: ['All Basic Benefits', 'Diet Plan', 'Locker Facility'],
                                description: 'Most Popular',
                                color: '#3a86ff',
                                discount: 10
                            },
                            {
                                _id: 'premium',
                                name: 'Premium',
                                price: 1800,
                                duration: '1 month',
                                benefits: ['All Standard Benefits', 'Personal Trainer', 'Spa & Sauna'],
                                description: 'For serious fitness',
                                color: '#8338ec',
                                discount: 15
                            }
                        ];
                    }

                    this.renderPlans(plans);
                    
                    // Populate plan dropdown like in gymadmin
                    this.populatePlanDropdown(plans);

                    // Pre-select default plan if specified
                    if (this.qrData && this.qrData.defaultPlan) {
                        this.selectPlan(this.qrData.defaultPlan);
                    }

                } catch (error) {
                    console.error('Error loading plans:', error);
                    this.showError('Failed to load membership plans');
                }
            }
            
            // Function to populate plan dropdown like in gymadmin
            populatePlanDropdown(plans) {
                const planSelect = document.getElementById('planSelected');
                if (!planSelect) return;
                
                planSelect.innerHTML = '<option value="">Select Plan</option>';
                
                plans.forEach(plan => {
                    const option = document.createElement('option');
                    option.value = plan.name;
                    option.textContent = `${plan.name} - ₹${plan.price}/${plan.duration || 'month'}`;
                    planSelect.appendChild(option);
                });
                
                // Add event listener for plan selection to update payment amount
                planSelect.addEventListener('change', () => {
                    this.updatePaymentAmount(plans);
                });
            }
            
            // Function to update payment amount based on selected plan and duration
            updatePaymentAmount(plans) {
                const planSelect = document.getElementById('planSelected');
                const monthlyPlanSelect = document.getElementById('monthlyPlan');
                const paymentAmountInput = document.getElementById('paymentAmount');
                const discountInfo = document.getElementById('discountInfo');
                const discountText = document.getElementById('discountText');
                
                if (!planSelect || !monthlyPlanSelect || !paymentAmountInput) return;
                
                const selectedPlanName = planSelect.value;
                const selectedDuration = monthlyPlanSelect.value;
                
                if (selectedPlanName && selectedDuration) {
                    const plan = plans.find(p => p.name === selectedPlanName);
                    if (plan) {
                        const basePrice = plan.price || 0;
                        const duration = parseInt(selectedDuration.split(' ')[0]) || 1;
                        let totalAmount = basePrice * duration;
                        
                        // Apply discount if available
                        let discount = 0;
                        if (plan.discount && plan.discount > 0) {
                            discount = (totalAmount * plan.discount) / 100;
                            totalAmount = totalAmount - discount;
                        }
                        
                        // Apply duration-based discounts
                        if (duration >= 12) {
                            const additionalDiscount = totalAmount * 0.15; // 15% for annual
                            totalAmount = totalAmount - additionalDiscount;
                            discount += additionalDiscount;
                        } else if (duration >= 6) {
                            const additionalDiscount = totalAmount * 0.10; // 10% for 6 months
                            totalAmount = totalAmount - additionalDiscount;
                            discount += additionalDiscount;
                        } else if (duration >= 3) {
                            const additionalDiscount = totalAmount * 0.05; // 5% for 3 months
                            totalAmount = totalAmount - additionalDiscount;
                            discount += additionalDiscount;
                        }
                        
                        paymentAmountInput.value = Math.round(totalAmount);
                        
                        // Show discount information
                        if (discount > 0 && discountInfo && discountText) {
                            discountInfo.style.display = 'block';
                            discountInfo.style.backgroundColor = '#e8f5e8';
                            discountInfo.style.color = '#2e7d32';
                            discountText.textContent = `Discount applied: ₹${Math.round(discount)} saved!`;
                        } else if (discountInfo) {
                            discountInfo.style.display = 'none';
                        }
                    }
                } else {
                    paymentAmountInput.value = '';
                    if (discountInfo) {
                        discountInfo.style.display = 'none';
                    }
                }
            }

            renderPlans(plans) {
                const plansGrid = document.getElementById('plansGrid');
                
                let badge = '';
                if (this.qrData && this.qrData.registrationType === 'trial') {
                    badge = '<span class="trial-badge">3-Day Trial</span>';
                } else if (this.qrData && this.qrData.registrationType === 'premium') {
                    badge = '<span class="premium-badge">Premium Access</span>';
                }

                plansGrid.innerHTML = plans.map(plan => {
                    const planId = plan._id || plan.name;
                    const planColor = plan.color || '#1976d2';
                    const planPrice = plan.price || 0;
                    const planDuration = plan.duration || '1 month';
                    const planBenefits = plan.benefits || ['Standard features'];
                    const planDescription = plan.description || plan.note || '';
                    const planDiscount = plan.discount || 0;
                    
                    let discountBadge = '';
                    if (planDiscount > 0) {
                        discountBadge = `<div style="position: absolute; top: -8px; right: -8px; background: #ff4444; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold;">${planDiscount}%</div>`;
                    }
                    
                    return `
                        <div class="plan-card" data-plan="${planId}" style="border-color: ${planColor}20; position: relative;">
                            ${discountBadge}
                            <div class="plan-name" style="color: ${planColor};">${plan.name}${badge}</div>
                            <div class="plan-price" style="color: ${planColor};">₹${planPrice}/${planDuration}</div>
                            <div class="plan-features">${planBenefits.join(' • ')}</div>
                            ${planDescription ? `<div style="font-size: 0.8rem; color: #666; margin-top: 8px; font-style: italic;">${planDescription}</div>` : ''}
                            ${planDiscount > 0 ? `<div style="font-size: 0.75rem; color: #ff4444; margin-top: 4px; font-weight: bold;">Save ${planDiscount}% on this plan!</div>` : ''}
                        </div>
                    `;
                }).join('');
            }

            setupForm() {
                // Add click handlers to plan cards
                document.querySelectorAll('.plan-card').forEach(card => {
                    card.addEventListener('click', () => {
                        const planId = card.getAttribute('data-plan');
                        this.selectPlan(planId);
                    });
                });
                
                // Add event listener for monthly plan changes to update payment
                const monthlyPlanSelect = document.getElementById('monthlyPlan');
                if (monthlyPlanSelect) {
                    monthlyPlanSelect.addEventListener('change', () => {
                        // Get current plans and update payment amount
                        if (this.gymData && this.gymData.membershipPlans) {
                            this.updatePaymentAmount(this.gymData.membershipPlans);
                        }
                    });
                }
                
                // Show special offer if available
                if (this.qrData && this.qrData.specialOffer) {
                    document.getElementById('offerText').textContent = this.qrData.specialOffer;
                    document.getElementById('specialOffer').classList.add('show');
                }
            }

            selectPlan(planId) {
                // Remove previous selection
                document.querySelectorAll('.plan-card').forEach(card => {
                    card.classList.remove('selected');
                });

                // Select new plan
                const selectedCard = document.querySelector(`[data-plan="${planId}"]`);
                if (selectedCard) {
                    selectedCard.classList.add('selected');
                    this.selectedPlan = planId;
                    document.getElementById('planSelected').value = planId;
                    
                    // Update payment amount if monthly plan is also selected
                    if (this.gymData && this.gymData.membershipPlans) {
                        this.updatePaymentAmount(this.gymData.membershipPlans);
                    }
                }
            }

            bindEvents() {
                document.getElementById('registrationForm').addEventListener('submit', (e) => {
                    this.handleSubmit(e);
                });
            }

            async handleSubmit(e) {
                e.preventDefault();

                if (!this.selectedPlan) {
                    this.showError('Please select a membership plan');
                    return;
                }

                const submitBtn = document.getElementById('submitBtn');
                submitBtn.classList.add('loading');
                submitBtn.disabled = true;

                try {
                    const formData = new FormData(e.target);
                    const registrationData = Object.fromEntries(formData.entries());

                    // Add QR-specific data
                    registrationData.registrationType = this.qrData.registrationType;
                    registrationData.specialOffer = this.qrData.specialOffer;

                    // Submit registration
                    const response = await fetch('/api/register-via-qr', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(registrationData)
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.message || 'Registration failed');
                    }

                    this.showSuccess('Registration successful! Welcome to the gym family!');
                    
                    // Redirect to payment or confirmation page
                    setTimeout(() => {
                        if (result.paymentUrl) {
                            window.location.href = result.paymentUrl;
                        } else {
                            window.location.href = '/registration-complete';
                        }
                    }, 2000);

                } catch (error) {
                    console.error('Registration error:', error);
                    this.showError(error.message || 'Registration failed. Please try again.');
                } finally {
                    submitBtn.classList.remove('loading');
                    submitBtn.disabled = false;
                }
            }

            showError(message) {
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                document.getElementById('successMessage').style.display = 'none';
                
                // Scroll to error
                errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            showSuccess(message) {
                const successDiv = document.getElementById('successMessage');
                successDiv.innerHTML = `
                    <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                    <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 5px;">Success!</div>
                    <div>${message}</div>
                `;
                successDiv.style.display = 'block';
                document.getElementById('errorMessage').style.display = 'none';
                
                // Scroll to success
                successDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new MemberRegistration();
        });
    </script>
</body>
</html>
