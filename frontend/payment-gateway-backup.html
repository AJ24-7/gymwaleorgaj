<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Payment - Gym Registration</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #1976d2;
            --primary-dark: #1565c0;
            --primary-light: #42a5f5;
            --secondary: #f44336;
            --success: #4caf50;
            --warning: #ff9800;
            --info: #2196f3;
            --light: #f8f9fa;
            --dark: #2d3748;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --border-color: #e2e8f0;
            --card-bg: #ffffff;
            --background: #f0f2f5;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 32px;
            text-align: center;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="0.5" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.1;
        }

        .header h1 {
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 12px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .content {
            padding: 32px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-light);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .card h3 {
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .card h3 i {
            color: var(--primary);
        }

        .payment-summary {
            background: linear-gradient(135deg, var(--light) 0%, #fff 100%);
            border-left: 4px solid var(--primary);
        }

        .pricing-breakdown {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            border: 1px solid #e9ecef;
        }

        .breakdown-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .breakdown-row.discount {
            color: #28a745;
            font-weight: 600;
        }

        .breakdown-row.total {
            border-top: 2px solid var(--border-color);
            padding-top: 12px;
            margin-top: 12px;
            font-size: 1.1rem;
            color: var(--primary);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 1rem;
            color: var(--text-primary);
        }

        .summary-row.total {
            border-top: 2px solid var(--border-color);
            padding-top: 16px;
            margin-top: 16px;
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--primary);
        }

        .member-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #fff 100%);
            border-left: 4px solid var(--info);
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .info-row strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .payment-method {
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            background: var(--card-bg);
        }

        .payment-method:hover {
            border-color: var(--primary-light);
            background: linear-gradient(135deg, rgba(25, 118, 210, 0.05) 0%, var(--card-bg) 100%);
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(25, 118, 210, 0.15);
        }

        .payment-method.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(25, 118, 210, 0.1) 0%, var(--card-bg) 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(25, 118, 210, 0.2);
        }

        .payment-method.selected::after {
            content: '‚úì';
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--success);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            border: 3px solid var(--card-bg);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .payment-method i {
            font-size: 2.5rem;
            margin-bottom: 12px;
            color: var(--primary);
            transition: all 0.3s ease;
        }

        .payment-method:hover i {
            color: var(--primary-dark);
            transform: scale(1.1);
        }

        .method-name {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .method-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            width: 100%;
            margin-bottom: 16px;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 4px 15px rgba(25, 118, 210, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(25, 118, 210, 0.4);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn.loading {
            pointer-events: none;
            opacity: 0.8;
        }

        .loading-spinner {
            display: none;
            border: 2px solid #ffffff40;
            border-top: 2px solid #ffffff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        .btn.loading .loading-spinner {
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }

        .alert.success {
            background: #e8f5e8;
            border: 1px solid var(--success);
            color: #2e7d32;
        }

        .alert.error {
            background: #ffebee;
            border: 1px solid var(--secondary);
            color: #c62828;
        }

        .alert.info {
            background: #e3f2fd;
            border: 1px solid var(--info);
            color: #1565c0;
        }

        .alert.warning {
            background: #fff3e0;
            border: 1px solid var(--warning);
            color: #e65100;
        }

        .secure-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            padding: 12px;
            background: var(--light);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .secure-badge i {
            color: var(--success);
        }

        .payment-form {
            display: none;
            background: var(--light);
            border-radius: 12px;
            padding: 24px;
            margin-top: 20px;
            border: 1px solid var(--border-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }

        @media (max-width: 768px) {
            .payment-methods {
                grid-template-columns: 1fr;
            }
            
            .content {
                padding: 20px;
            }
            
            .cash-validation-modal {
                width: 95%;
                margin: 10px;
                padding: 24px 20px;
            }
            
            .validation-code {
                font-size: 1.2rem !important;
                letter-spacing: 1px !important;
            }
            
            .validation-details > div {
                flex-direction: column;
                align-items: flex-start;
                text-align: left;
            }
            
            .validation-details span:not(:first-child) {
                text-align: left;
                margin-top: 4px;
            }
            
            .validation-timer {
                font-size: 2rem;
            }
        }

        /* Cash Payment Validation Modal Styles */
        .cash-validation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .cash-validation-modal {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 32px;
            max-width: 580px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            animation: slideInUp 0.4s ease-out;
            border: 1px solid var(--border-color);
            margin: 20px;
        }

        @keyframes slideInUp {
            from {
                transform: translateY(30px) scale(0.95);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .validation-icon {
            font-size: 4rem;
            color: var(--warning);
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .validation-timer {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--secondary);
            margin: 20px 0;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            background: linear-gradient(135deg, var(--secondary) 0%, #ff7043 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .validation-message {
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 24px;
            line-height: 1.6;
            font-weight: 500;
        }

        .validation-details {
            background: linear-gradient(135deg, var(--light) 0%, #fff 100%);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
            border: 1px solid var(--border-color);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .validation-details > div {
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 8px;
        }

        .validation-details > div:last-child {
            margin-bottom: 0;
        }

        .validation-details strong {
            color: var(--text-primary);
            font-weight: 600;
            min-width: 120px;
            flex-shrink: 0;
        }

        .validation-details span:not(:first-child) {
            flex: 1;
            text-align: right;
            word-break: break-word;
        }

        .validation-code {
            font-size: 1.4rem !important;
            font-weight: 700 !important;
            color: var(--primary) !important;
            letter-spacing: 2px !important;
            font-family: 'JetBrains Mono', 'Courier New', monospace !important;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            padding: 12px 8px;
            background-color: rgba(25, 118, 210, 0.1);
            border-radius: 8px;
            margin: 8px 0;
            word-break: break-all;
            max-width: 100%;
            overflow-wrap: break-word;
        }

        .validation-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 16px 20px;
            border-radius: 10px;
            margin-top: 24px;
            font-weight: 600;
            font-size: 1rem;
        }

        .validation-status.pending {
            background: linear-gradient(135deg, #fff3e0 0%, #ffcc80 100%);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        .validation-status.approved {
            background: linear-gradient(135deg, #e8f5e8 0%, #a5d6a7 100%);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .validation-status.expired {
            background: linear-gradient(135deg, #ffebee 0%, #ef9a9a 100%);
            color: var(--secondary);
            border: 1px solid var(--secondary);
        }

        .qr-code-section {
            margin: 24px 0;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 12px;
            border: 2px solid var(--primary);
            display: none;
        }

        .qr-code-section.show {
            display: block;
        }

        .qr-code-container {
            display: flex;
            justify-content: center;
            margin: 16px 0;
        }

        .qr-code {
            padding: 16px;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-credit-card"></i> Complete Payment</h1>
            <p>Secure payment gateway for your gym membership</p>
        </div>

        <div class="content">
            <!-- Member Information -->
            <div class="card member-info">
                <h3><i class="fas fa-user-circle"></i> Member Information</h3>
                <div class="info-row">
                    <span><strong><i class="fas fa-user"></i> Name:</strong></span>
                    <span id="memberName">Loading...</span>
                </div>
                <div class="info-row">
                    <span><strong><i class="fas fa-envelope"></i> Email:</strong></span>
                    <span id="memberEmail">Loading...</span>
                </div>
                <div class="info-row">
                    <span><strong><i class="fas fa-dumbbell"></i> Plan:</strong></span>
                    <span id="membershipPlan">Loading...</span>
                </div>
            </div>

            <!-- Payment Summary -->
            <div class="card payment-summary">
                <h3><i class="fas fa-receipt"></i> Payment Summary</h3>
                <div class="summary-row">
                    <span><i class="fas fa-tag"></i> Membership Plan:</span>
                    <span id="planAmount">‚Çπ0</span>
                </div>
                <div class="summary-row">
                    <span><i class="fas fa-calendar-alt"></i> Duration:</span>
                    <span id="planDuration">1 month</span>
                </div>
                <div class="summary-row" id="taxRow" style="display: none;">
                    <span><i class="fas fa-percent"></i> Tax (GST 18%):</span>
                    <span id="taxAmount">‚Çπ0</span>
                </div>
                <div class="summary-row total">
                    <span><i class="fas fa-rupee-sign"></i> Total Amount:</span>
                    <span id="totalAmount">‚Çπ0</span>
                </div>
            </div>

            <!-- Alert Area -->
            <div id="alertArea"></div>

            <!-- Payment Methods -->
            <div class="card">
                <h3><i class="fas fa-wallet"></i> Select Payment Method</h3>
                <div class="payment-methods">
                    <div class="payment-method" data-method="razorpay">
                        <i class="fas fa-credit-card"></i>
                        <div class="method-name">Razorpay</div>
                        <div class="method-desc">Cards, UPI, Wallets, Net Banking</div>
                    </div>
                    
                    <div class="payment-method" data-method="upi">
                        <i class="fas fa-mobile-alt"></i>
                        <div class="method-name">UPI Direct</div>
                        <div class="method-desc">Pay directly with UPI apps</div>
                    </div>
                    
                    <div class="payment-method" data-method="stripe">
                        <i class="fas fa-globe-americas"></i>
                        <div class="method-name">Stripe</div>
                        <div class="method-desc">International Cards</div>
                    </div>
                    
                    <div class="payment-method" data-method="paypal">
                        <i class="fab fa-paypal"></i>
                        <div class="method-name">PayPal</div>
                        <div class="method-desc">PayPal Account</div>
                    </div>

                    <div class="payment-method" data-method="cash">
                        <i class="fas fa-money-bill-wave"></i>
                        <div class="method-name">Cash Payment</div>
                        <div class="method-desc">Pay at gym counter</div>
                    </div>
                </div>
            </div>

            <!-- Payment Form (for card details if needed) -->
            <div class="payment-form" id="paymentForm">
                <h4 style="margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-credit-card"></i> Enter Payment Details
                </h4>
                <div class="form-group">
                    <label><i class="fas fa-credit-card"></i> Card Number</label>
                    <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label><i class="fas fa-calendar"></i> Expiry Date</label>
                        <input type="text" id="expiryDate" placeholder="MM/YY" maxlength="5">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-lock"></i> CVV</label>
                        <input type="text" id="cvv" placeholder="123" maxlength="4">
                    </div>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-user"></i> Cardholder Name</label>
                    <input type="text" id="cardholderName" placeholder="Full Name">
                </div>
            </div>

            <!-- Payment Button -->
            <button class="btn" id="payButton" onclick="initiatePayment()" disabled>
                <div class="loading-spinner"></div>
                <i class="fas fa-hand-pointer"></i>
                <span>Select Payment Method</span>
            </button>

            <!-- Security Badge -->
            <div class="secure-badge">
                <i class="fas fa-shield-alt"></i>
                <span>Secured by SSL encryption</span>
            </div>
        </div>
    </div>

    <script>
        let memberData = {};
        let paymentData = {};
        let selectedMethod = null;

        // Initialize payment page
        window.addEventListener('load', async () => {
            try {
                console.log('üöÄ Initializing payment gateway...');
                
                // Get URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const type = urlParams.get('type'); // 'membership' or 'trial'
                
                console.log('Payment type:', type);
                console.log('All URL params:', Object.fromEntries(urlParams.entries()));
                
                if (type === 'membership') {
                    await loadMembershipPaymentData(urlParams);
                } else {
                    // Legacy QR registration flow
                    const memberId = urlParams.get('member');
                    const planName = urlParams.get('planName');
                    const amount = urlParams.get('amount');
                    const duration = urlParams.get('duration') || '1';
                    const username = urlParams.get('username');
                    const email = urlParams.get('email');
                    const phone = urlParams.get('phone');
                    const gymId = urlParams.get('gymId');

                    console.log('Legacy registration params:', {
                        memberId, planName, amount, duration, username, email, phone, gymId
                    });

                    if (!username || !email) {
                        showAlert('Invalid payment link. Please contact support.', 'error');
                        return;
                    }

                    await loadPaymentData(memberId, planName, amount, duration, username, email, phone, gymId);
                }
            } catch (error) {
                console.error('‚ùå Error initializing payment gateway:', error);
                showAlert('Failed to initialize payment gateway. Please try again.', 'error');
            }
        });

        // Load membership payment data from URL params and session storage
        async function loadMembershipPaymentData(urlParams) {
            try {
                console.log('üîç Loading membership payment data...');
                console.log('URL Params:', Object.fromEntries(urlParams.entries()));
                
                const membershipDataString = sessionStorage.getItem('membershipRegistrationData');
                const userToken = sessionStorage.getItem('userToken');
                
                console.log('Session Storage Data:', membershipDataString);
                console.log('User Token:', userToken ? 'Present' : 'Missing');
                
                // Parse membership data safely
                let membershipData = {};
                try {
                    membershipData = membershipDataString ? JSON.parse(membershipDataString) : {};
                } catch (parseError) {
                    console.error('‚ùå Error parsing session data:', parseError);
                    membershipData = {};
                }
                
                // If no session data, try to fetch user profile using token
                if (!membershipData.memberName && userToken) {
                    try {
                        console.log('üîÑ Fetching user profile to populate member data...');
                        const response = await fetch('/api/users/profile', {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${userToken}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            const userData = await response.json();
                            console.log('‚úÖ User profile fetched:', userData);
                            
                            // Populate membershipData with user profile data
                            membershipData.memberName = userData.name || userData.username;
                            membershipData.email = userData.email;
                            membershipData.phone = userData.phone;
                            membershipData.age = userData.age || (userData.dateOfBirth ? calculateAge(userData.dateOfBirth) : 25);
                            membershipData.gender = userData.gender || 'Other';
                            membershipData.address = userData.address || '';
                        } else {
                            console.warn('‚ö†Ô∏è Failed to fetch user profile:', response.status);
                        }
                    } catch (profileError) {
                        console.error('‚ùå Error fetching user profile:', profileError);
                    }
                }
                
                console.log('Parsed Membership Data:', membershipData);
                
                // Check if we have enough data to proceed
                const hasSessionData = membershipData.gymId || membershipData.memberName;
                const hasUrlData = urlParams.get('gymId') && urlParams.get('planName');
                
                if (!hasSessionData && !hasUrlData) {
                    console.error('‚ùå Insufficient data for membership payment');
                    showAlert('Invalid membership purchase data. Please try again from the gym details page.', 'error');
                    return;
                }

                // Extract data with fallbacks
                const duration = parseInt(urlParams.get('duration')) || membershipData.duration || 1;
                const monthlyPrice = parseFloat(urlParams.get('monthlyPrice')) || 
                                   membershipData.monthlyPrice || 
                                   membershipData.originalPrice || 
                                   parseFloat(urlParams.get('originalPrice')) || 
                                   parseFloat(urlParams.get('amount')) || 0;
                
                const totalAmount = parseFloat(urlParams.get('amount')) || 
                                   membershipData.paymentAmount || 
                                   membershipData.finalAmount || 
                                   membershipData.totalAmount || 
                                   monthlyPrice;
                
                const originalAmount = parseFloat(urlParams.get('originalAmount')) || 
                                     membershipData.totalOriginalAmount || 
                                     (monthlyPrice * duration);
                
                const discountAmount = parseFloat(urlParams.get('discountAmount')) || 
                                     membershipData.discountAmount || 0;
                
                console.log('Calculated Values:', {
                    duration,
                    monthlyPrice,
                    totalAmount,
                    originalAmount,
                    discountAmount
                });
                
                const durationText = duration === 1 ? '1 Month' : 
                                  duration === 3 ? '3 Months' : 
                                  duration === 6 ? '6 Months' : 
                                  duration === 12 ? '12 Months' : 
                                  `${duration} Month${duration > 1 ? 's' : ''}`;

                // Build payment data object with comprehensive fallbacks
                paymentData = {
                    type: 'membership',
                    memberId: 'new_membership_' + Date.now(),
                    planName: urlParams.get('planName') || 
                             membershipData.planSelected || 
                             membershipData.planName || 
                             'Membership Plan',
                    baseAmount: monthlyPrice,
                    originalPrice: parseFloat(urlParams.get('originalPrice')) || 
                                  membershipData.originalPrice || 
                                  monthlyPrice,
                    discount: parseFloat(urlParams.get('discount')) || 
                             membershipData.discount || 0,
                    totalAmount: totalAmount,
                    originalAmount: originalAmount,
                    discountAmount: discountAmount,
                    duration: duration,
                    durationText: durationText,
                    monthlyPrice: monthlyPrice,
                    username: urlParams.get('name') || 
                             membershipData.memberName || 
                             membershipData.username || 
                             'Member',
                    email: urlParams.get('email') || 
                          membershipData.email || 
                          'member@example.com',
                    phone: urlParams.get('phone') || 
                          membershipData.phone || 
                          'N/A',
                    gymId: urlParams.get('gymId') || 
                          membershipData.gymId || 
                          'unknown',
                    gymName: urlParams.get('gymName') || 
                            membershipData.gymName || 
                            'Gym',
                    userToken: userToken,
                    membershipData: membershipData,
                    registrationType: 'online_membership', // Flag for online membership
                    isOnlineRegistration: true // Additional flag for UI logic
                };

                console.log('Final Payment Data:', paymentData);

                // Validate that we have essential data
                if (!paymentData.gymId || paymentData.gymId === 'unknown') {
                    console.warn('‚ö†Ô∏è Missing gym ID, payment may fail');
                    showAlert('Missing gym information. Please restart from gym details page.', 'warning');
                }

                if (!paymentData.username || paymentData.username === 'Member') {
                    console.warn('‚ö†Ô∏è Missing member name, payment may fail');
                    showAlert('Missing member information. Please restart from gym details page.', 'warning');
                }

                if (paymentData.totalAmount <= 0) {
                    console.error('‚ùå Invalid payment amount');
                    showAlert('Invalid payment amount. Please restart from gym details page.', 'error');
                    return;
                }

                // Update UI elements safely
                updateUIElement('memberName', paymentData.username);
                updateUIElement('memberEmail', paymentData.email);
                updateUIElement('membershipPlan', paymentData.planName);
                updateUIElement('planAmount', `‚Çπ${paymentData.monthlyPrice}/month`);
                updateUIElement('planDuration', paymentData.durationText);
                updateUIElement('taxAmount', '‚Çπ0');
                updateUIElement('totalAmount', `‚Çπ${paymentData.totalAmount}`);

                console.log('‚úÖ UI elements updated successfully');

                // Show gym information if available
                if (paymentData.gymName && paymentData.gymName !== 'Gym') {
                    const gymNameElement = document.getElementById('gymName');
                    if (gymNameElement) {
                        gymNameElement.textContent = paymentData.gymName;
                    } else {
                        // Add gym name to the payment summary if element doesn't exist
                        const paymentSummary = document.querySelector('.payment-summary');
                        if (paymentSummary) {
                            const gymInfo = document.createElement('div');
                            gymInfo.className = 'gym-info';
                            gymInfo.innerHTML = `
                                <div style="background: #f0f8ff; padding: 10px; border-radius: 6px; margin-bottom: 15px; border-left: 3px solid #007bff;">
                                    <strong><i class="fas fa-dumbbell"></i> ${paymentData.gymName}</strong>
                                </div>
                            `;
                            paymentSummary.insertBefore(gymInfo, paymentSummary.firstChild);
                        }
                    }
                }

                // Show detailed pricing breakdown if duration > 1 month
                if (duration > 1 && monthlyPrice > 0) {
                    addPricingBreakdown(duration, monthlyPrice, originalAmount, discountAmount, totalAmount, paymentData.discount);
                }

                // Show discount information if applicable
                if (paymentData.discount > 0 && discountAmount > 0) {
                    addDiscountInfo(paymentData.discount, discountAmount, duration);
                }

                console.log('‚úÖ Membership payment data loaded successfully:', paymentData);
                
                // Hide cash payment option for online membership purchases
                hideCashPaymentForOnlineMembers();
                
            } catch (error) {
                console.error('‚ùå Error loading membership payment data:', error);
                showAlert('Failed to load membership payment data. Please try again.', 'error');
            }
        }

        // Hide cash payment option for online membership purchases
        function hideCashPaymentForOnlineMembers() {
            try {
                const cashPaymentMethod = document.querySelector('[data-method="cash"]');
                if (cashPaymentMethod && (paymentData.type === 'membership' || paymentData.isOnlineRegistration)) {
                    console.log('üö´ Hiding cash payment option for online membership purchase');
                    cashPaymentMethod.style.display = 'none';
                    
                    // If cash was previously selected, reset selection
                    if (selectedMethod === 'cash') {
                        selectedMethod = null;
                        document.querySelectorAll('.payment-method').forEach(method => {
                            method.classList.remove('selected');
                        });
                        
                        // Update pay button
                        const payButton = document.getElementById('payButton');
                        if (payButton) {
                            payButton.disabled = true;
                            payButton.innerHTML = `
                                <div class="loading-spinner"></div>
                                <i class="fas fa-credit-card"></i>
                                <span>Select Payment Method</span>
                            `;
                        }
                    }
                    
                    // Add a notice for online membership users
                    const paymentMethodsContainer = document.querySelector('.payment-methods');
                    if (paymentMethodsContainer && !paymentMethodsContainer.querySelector('.online-membership-notice')) {
                        const onlineNotice = document.createElement('div');
                        onlineNotice.className = 'online-membership-notice';
                        onlineNotice.innerHTML = `
                            <div style="background: linear-gradient(135deg, #e3f2fd 0%, #f0f8ff 100%); 
                                        padding: 15px; 
                                        border-radius: 8px; 
                                        margin-bottom: 20px; 
                                        border-left: 4px solid #2196f3; 
                                        color: #1565c0;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <i class="fas fa-info-circle" style="color: #2196f3;"></i>
                                    <strong>Online Membership Registration</strong>
                                </div>
                                <small style="color: #1976d2;">
                                    Cash payment is not available for online membership purchases. 
                                    Please choose from the available digital payment methods below.
                                </small>
                            </div>
                        `;
                        paymentMethodsContainer.insertBefore(onlineNotice, paymentMethodsContainer.firstChild);
                    }
                    
                    // Auto-select first available payment method if none selected
                    if (!selectedMethod) {
                        const firstAvailableMethod = document.querySelector('.payment-method:not([style*="display: none"])');
                        if (firstAvailableMethod) {
                            setTimeout(() => {
                                firstAvailableMethod.click();
                            }, 100);
                        }
                    }
                }
            } catch (error) {
                console.error('‚ùå Error hiding cash payment option:', error);
            }
        }

        // Helper function to safely update UI elements
        function updateUIElement(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = value;
            } else {
                console.warn(`‚ö†Ô∏è Element with ID '${elementId}' not found`);
            }
        }

        // Helper function to add pricing breakdown
        function addPricingBreakdown(duration, monthlyPrice, originalAmount, discountAmount, totalAmount, discountPercent) {
            try {
                const pricingBreakdown = document.createElement('div');
                pricingBreakdown.className = 'pricing-breakdown';
                pricingBreakdown.innerHTML = `
                    <div class="breakdown-row">
                        <span>Monthly Price:</span>
                        <span>‚Çπ${monthlyPrice}</span>
                    </div>
                    <div class="breakdown-row">
                        <span>Duration:</span>
                        <span>${duration} month${duration > 1 ? 's' : ''}</span>
                    </div>
                    <div class="breakdown-row">
                        <span>Subtotal:</span>
                        <span>‚Çπ${originalAmount}</span>
                    </div>
                    ${discountAmount > 0 ? `
                    <div class="breakdown-row discount">
                        <span>Discount (${discountPercent}%):</span>
                        <span>-‚Çπ${discountAmount}</span>
                    </div>` : ''}
                    <div class="breakdown-row total">
                        <span><strong>Total Amount:</strong></span>
                        <span><strong>‚Çπ${totalAmount}</strong></span>
                    </div>
                `;
                
                const paymentSummary = document.querySelector('.payment-summary');
                if (paymentSummary) {
                    paymentSummary.appendChild(pricingBreakdown);
                    console.log('‚úÖ Pricing breakdown added');
                }
            } catch (error) {
                console.error('‚ùå Error adding pricing breakdown:', error);
            }
        }

        // Helper function to add discount information
        function addDiscountInfo(discountPercent, discountAmount, duration) {
            try {
                const discountElement = document.createElement('div');
                discountElement.innerHTML = `
                    <div class="discount-info" style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0; color: #2d5a2d; border-left: 4px solid #4caf50;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                            <i class="fas fa-tags"></i> 
                            <strong>${discountPercent}% Discount Applied!</strong>
                        </div>
                        <small>You saved ‚Çπ${discountAmount} on this ${duration}-month plan</small>
                    </div>
                `;
                const paymentSummary = document.querySelector('.payment-summary');
                if (paymentSummary) {
                    paymentSummary.appendChild(discountElement);
                    console.log('‚úÖ Discount info added');
                }
            } catch (error) {
                console.error('‚ùå Error adding discount info:', error);
            }
        }

        async function loadPaymentData(memberId, planName, amount, duration, username, email, phone, gymId) {
            try {
                // For now, use URL parameters. In production, fetch from backend
                const baseAmount = parseFloat(amount) || 1000;
                const durationMonths = parseInt(duration) || 1;
                const durationText = durationMonths === 1 ? '1 Month' : 
                                  durationMonths === 3 ? '3 Months' : 
                                  durationMonths === 6 ? '6 Months' : 
                                  durationMonths === 12 ? '12 Months' : `${durationMonths} Month(s)`;

                paymentData = {
                    memberId: memberId || 'new_member_' + Date.now(),
                    planName: decodeURIComponent(planName) || 'Membership Plan',
                    baseAmount: baseAmount,
                    totalAmount: baseAmount, // No GST added
                    duration: durationMonths,
                    durationText: durationText,
                    username: decodeURIComponent(username) || 'Member',
                    email: decodeURIComponent(email) || 'member@example.com',
                    phone: decodeURIComponent(phone) || '',
                    gymId: gymId || 'default_gym'
                };

                // Update UI with actual member information
                document.getElementById('memberName').textContent = paymentData.username;
                document.getElementById('memberEmail').textContent = paymentData.email;
                document.getElementById('membershipPlan').textContent = paymentData.planName;
                document.getElementById('planAmount').textContent = `‚Çπ${paymentData.baseAmount}`;
                document.getElementById('planDuration').textContent = paymentData.durationText;
                document.getElementById('taxAmount').textContent = '‚Çπ0'; // No tax
                document.getElementById('totalAmount').textContent = `‚Çπ${paymentData.totalAmount}`;

                console.log('Payment data loaded:', paymentData);
            } catch (error) {
                console.error('Error loading payment data:', error);
                showAlert('Failed to load payment information. Please try again.', 'error');
            }
        }

        // Handle payment method selection
        document.querySelectorAll('.payment-method').forEach(method => {
            method.addEventListener('click', function() {
                // Check if this is cash payment for online membership
                if (this.dataset.method === 'cash' && paymentData.isOnlineRegistration) {
                    console.log('üö´ Cash payment not allowed for online membership registration');
                    showAlert('Cash payment is not available for online membership registration. Please choose an online payment method.', 'warning');
                    return;
                }
                
                // Remove previous selection
                document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
                
                // Select this method
                this.classList.add('selected');
                selectedMethod = this.dataset.method;
                
                // Update button
                const payButton = document.getElementById('payButton');
                payButton.disabled = false;
                
                // Special handling for cash payment
                if (selectedMethod === 'cash') {
                    payButton.innerHTML = `
                        <div class="loading-spinner"></div>
                        <i class="fas fa-qrcode"></i>
                        <span>Generate QR Payment Code - ‚Çπ${paymentData.totalAmount}</span>
                    `;
                } else {
                    payButton.innerHTML = `
                        <div class="loading-spinner"></div>
                        <i class="fas fa-credit-card"></i>
                        <span>Pay ‚Çπ${paymentData.totalAmount} via ${this.querySelector('.method-name').textContent}</span>
                    `;
                }
                
                // Show/hide payment form based on method
                const paymentForm = document.getElementById('paymentForm');
                if (selectedMethod === 'stripe') {
                    paymentForm.style.display = 'block';
                } else {
                    paymentForm.style.display = 'none';
                }
                
                console.log('Selected payment method:', selectedMethod);
            });
        });

        async function initiatePayment() {
            if (!selectedMethod) {
                showAlert('Please select a payment method', 'error');
                return;
            }

            const payButton = document.getElementById('payButton');
            payButton.classList.add('loading');
            payButton.disabled = true;

            try {
                console.log('Creating payment session...');
                
                if (selectedMethod === 'cash') {
                    // Handle cash payment directly without backend session for now
                    await handleCashPayment();
                    return;
                }
                
                // Create payment session for other methods
                const response = await fetch('/api/payment/create-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        memberId: paymentData.memberId,
                        amount: paymentData.baseAmount,
                        duration: paymentData.duration,
                        paymentMethod: selectedMethod,
                        username: paymentData.username,
                        email: paymentData.email,
                        phone: paymentData.phone,
                        gymId: paymentData.gymId
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Failed to create payment session');
                }

                console.log('Payment session created:', result);
                
                // Handle different payment methods
                switch (selectedMethod) {
                    case 'razorpay':
                        await handleRazorpayPayment(result.paymentSession);
                        break;
                    case 'upi':
                        await handleUPIPayment(result.paymentSession);
                        break;
                    case 'stripe':
                        await handleStripePayment(result.paymentSession);
                        break;
                    case 'paypal':
                        await handlePayPalPayment(result.paymentSession);
                        break;
                    default:
                        throw new Error('Payment method not implemented yet');
                }

            } catch (error) {
                console.error('Payment initiation error:', error);
                showAlert(error.message || 'Payment initiation failed. Please try again.', 'error');
            } finally {
                payButton.classList.remove('loading');
                payButton.disabled = false;
            }
        }

        async function handleCashPayment() {
            try {
                // Remove any existing alert before showing modal
                document.getElementById('alertArea').innerHTML = '';
                
                console.log('Creating cash validation request with data:', paymentData);
                
                // Create cash payment request with full member registration data
                const cashPaymentData = {
                    memberName: paymentData.username,
                    email: paymentData.email,
                    phone: paymentData.phone || '',
                    planName: paymentData.planName,
                    duration: paymentData.durationText,
                    amount: paymentData.totalAmount,
                    gymId: paymentData.gymId || 'default_gym'
                };

                console.log('Creating cash validation request...', cashPaymentData);
                
                // Create cash validation request via API
                const response = await fetch('/api/payments/create-cash-validation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(cashPaymentData)
                });
                
                if (!response.ok) {
                    throw new Error('Failed to create cash validation request');
                }
                
                const result = await response.json();
                
                if (result.success) {
                    // Show validation dialog instantly with API response data
                    showCashValidationDialog(result.validationCode, result.expiresAt, cashPaymentData);
                } else {
                    throw new Error(result.error || 'Failed to create validation request');
                }
                
            } catch (error) {
                console.error('Cash payment error:', error);
                showAlert('Failed to initiate cash payment validation. Please try again.', 'error');
            }
        }

        function generateMockQRCode(validationCode) {
            // Generate comprehensive QR code data for cash payment validation
            const qrData = {
                type: 'gym_cash_payment',
                validationCode: validationCode,
                amount: paymentData.totalAmount,
                memberName: paymentData.username,
                memberEmail: paymentData.email,
                planName: paymentData.planName,
                duration: paymentData.durationText,
                gymId: paymentData.gymId,
                timestamp: new Date().toISOString(),
                // Additional member registration data for gym admin
                memberData: {
                    name: paymentData.username,
                    email: paymentData.email,
                    phone: paymentData.phone || '',
                    planSelected: paymentData.planName,
                    monthlyPlan: paymentData.durationText,
                    paymentAmount: paymentData.totalAmount,
                    paymentMode: 'cash',
                    paymentStatus: 'pending',
                    joinDate: new Date().toISOString(),
                    membershipId: `CASH${validationCode}`,
                    activityPreference: 'General Fitness'
                }
            };
            
            console.log('üîó Generated QR Data for gym admin:', qrData);
            
            // Create QR code with all member registration data
            const qrDataString = JSON.stringify(qrData);
            return `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrDataString)}`;
        }

        function showCashValidationDialog(validationCode, expiresAt, memberData) {
            const modal = document.createElement('div');
            modal.className = 'cash-validation-overlay';
            modal.id = 'cashValidationModal';
            
            const expiresAtDate = new Date(expiresAt);
            const now = new Date();
            const timeLeft = Math.max(0, Math.floor((expiresAtDate - now) / 1000));
            
            modal.innerHTML = `
                <div class="cash-validation-modal">
                    <div class="validation-icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    
                    <h2 style="color: var(--primary); margin-bottom: 16px; font-size: 1.8rem;">
                        Cash Payment Required
                    </h2>
                    
                    <div class="validation-timer" id="validationTimer">
                        ${formatTime(timeLeft)}
                    </div>
                    
                    <div class="validation-message">
                        Please pay the amount mentioned below at the gym counter within the time limit.
                    </div>

                    <div class="validation-details">
                        <div><strong>Member Name:</strong> <span>${memberData.memberName}</span></div>
                        <div><strong>Email:</strong> <span>${memberData.email}</span></div>
                        <div><strong>Phone:</strong> <span>${memberData.phone}</span></div>
                        <div><strong>Plan Selected:</strong> <span>${memberData.planName}</span></div>
                        <div><strong>Duration:</strong> <span>${memberData.duration}</span></div>
                        <div><strong>Payment Amount:</strong> <span style="color: var(--primary); font-weight: 700; font-size: 1.2rem;">‚Çπ${memberData.amount}</span></div>
                        <div style="flex-direction: column; align-items: center; text-align: center;"><strong>Validation Code:</strong> 
                            <div class="validation-code">${validationCode}</div>
                        </div>
                    </div>

                    <div class="validation-status pending" id="validationStatus">
                        <i class="fas fa-clock"></i>
                        <span>Waiting for payment confirmation...</span>
                    </div>

                    <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="closeCashValidationDialog()" style="background: var(--secondary); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; min-width: 120px;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Start countdown timer and status polling
            startCashValidationTimer(timeLeft, validationCode, memberData);
            startStatusPolling(validationCode);
        }

        function startCashValidationTimer(timeLeft, validationCode, memberData) {
            const timer = setInterval(() => {
                timeLeft--;
                const timerElement = document.getElementById('validationTimer');
                
                if (timerElement) {
                    timerElement.textContent = formatTime(timeLeft);
                    
                    if (timeLeft <= 30 && timeLeft > 0) {
                        timerElement.style.color = 'var(--warning)';
                    }
                    
                    if (timeLeft <= 10 && timeLeft > 0) {
                        timerElement.style.color = 'var(--secondary)';
                        timerElement.style.animation = 'pulse 1s infinite';
                    }
                    
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        updateValidationStatus('expired', 'Payment time expired. Please try again.');
                    }
                }
            }, 1000);
            
            // Store timer reference for cleanup
            window.cashValidationTimer = timer;
        }

        function startStatusPolling(validationCode) {
            // Poll every 3 seconds to check validation status
            const statusPolling = setInterval(async () => {
                try {
                    const response = await fetch(`/api/payments/validation-status/${validationCode}`);
                    if (response.ok) {
                        const result = await response.json();
                        
                        if (result.success && result.status !== 'pending') {
                            clearInterval(statusPolling);
                            
                            if (result.status === 'confirmed') {
                                updateValidationStatus('approved', '‚úÖ Payment confirmed by gym admin! Registration successful!');
                                
                                setTimeout(() => {
                                    closeCashValidationDialog();
                                    showAlert('Payment successful! You have been registered as a member.', 'success');
                                    
                                    // Redirect to success page
                                    setTimeout(() => {
                                        window.location.href = '/frontend/registration-complete.html';
                                    }, 2000);
                                }, 2000);
                                
                            } else if (result.status === 'rejected') {
                                updateValidationStatus('expired', '‚ùå Payment was rejected by gym admin.');
                                
                                setTimeout(() => {
                                    closeCashValidationDialog();
                                    showAlert('Payment was rejected by gym admin. Please try again or contact support.', 'error');
                                    
                                    // Redirect to cancel page
                                    setTimeout(() => {
                                        window.location.href = '/frontend/payment-cancel.html';
                                    }, 2000);
                                }, 2000);
                                
                            } else if (result.status === 'expired') {
                                updateValidationStatus('expired', '‚è∞ Validation expired. Please try again.');
                                
                                setTimeout(() => {
                                    closeCashValidationDialog();
                                    showAlert('Validation code expired. Please try creating a new payment request.', 'warning');
                                    
                                    // Redirect to payment gateway to try again
                                    setTimeout(() => {
                                        window.location.reload();
                                    }, 2000);
                                }, 2000);
                            }
                        }
                        
                    }
                } catch (error) {
                    console.error('Status polling error:', error);
                }
            }, 3000);
            
            // Store polling reference for cleanup  
            window.cashValidationStatusPolling = statusPolling;
        }

        async function confirmCashPayment(validationCode, memberDataString) {
            try {
                // Parse member data
                const memberData = JSON.parse(memberDataString.replace(/&quot;/g, '"'));
                
                updateValidationStatus('approved', 'Processing payment and creating member account...');
                
                // Simulate member registration API call
                const memberRegistrationData = {
                    memberName: memberData.memberData.memberName,
                    memberEmail: memberData.memberData.memberEmail,
                    memberPhone: memberData.memberData.memberPhone,
                    planSelected: memberData.memberData.planSelected,
                    monthlyPlan: memberData.memberData.monthlyPlan,
                    paymentAmount: memberData.memberData.paymentAmount,
                    paymentMode: 'cash',
                    paymentStatus: 'paid',
                    validationCode: validationCode,
                    gymId: memberData.gymId
                };

                // Call member registration API
                const response = await fetch('/api/members/register-cash-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(memberRegistrationData)
                });

                if (response.ok) {
                    const result = await response.json();
                    updateValidationStatus('approved', '‚úÖ Payment confirmed! Member registered successfully!');
                    
                    setTimeout(() => {
                        closeCashValidationDialog();
                        showAlert('Payment successful! Member has been added to the system.', 'success');
                        
                        // Redirect to success page
                        setTimeout(() => {
                            window.location.href = '/frontend/payment-success.html?member=' + encodeURIComponent(memberData.memberData.memberName);
                        }, 2000);
                    }, 2000);
                } else {
                    throw new Error('Failed to register member');
                }
                
            } catch (error) {
                console.error('Payment confirmation error:', error);
                
                // For demo purposes, simulate success
                updateValidationStatus('approved', '‚úÖ Payment confirmed! Member registered successfully! (Demo Mode)');
                
                setTimeout(() => {
                    closeCashValidationDialog();
                    showAlert('Payment successful! Member has been added to the system. (Demo Mode)', 'success');
                    
                    // Redirect to success page
                    setTimeout(() => {
                        window.location.href = '/frontend/payment-success.html?demo=true';
                    }, 2000);
                }, 2000);
            }
        }

        function closeCashValidationDialog() {
            const modal = document.getElementById('cashValidationModal');
            if (modal) {
                modal.remove();
            }
            
            // Clear timer
            if (window.cashValidationTimer) {
                clearInterval(window.cashValidationTimer);
                window.cashValidationTimer = null;
            }
            
            // Clear status polling
            if (window.cashValidationStatusPolling) {
                clearInterval(window.cashValidationStatusPolling);
                window.cashValidationStatusPolling = null;
            }
            
            // Clear validation polling
            if (window.cashValidationPolling) {
                clearInterval(window.cashValidationPolling);
                window.cashValidationPolling = null;
            }
            
            // Show cancel message and redirect
            showAlert('Payment validation cancelled. You can try again later.', 'info');
            
            setTimeout(() => {
                window.location.href = '/frontend/payment-cancel.html';
            }, 2000);
        }

        function showCashValidationModal(validationCode, expiresAt, qrCodeUrl) {
            const modal = document.createElement('div');
            modal.className = 'cash-validation-overlay';
            modal.id = 'cashValidationModal';
            
            const expiresAtDate = new Date(expiresAt);
            const now = new Date();
            const timeLeft = Math.max(0, Math.floor((expiresAtDate - now) / 1000));
            
            modal.innerHTML = `
                <div class="cash-validation-modal">
                    <div class="validation-icon">
                        <i class="fas fa-qrcode"></i>
                    </div>
                    <h2><i class="fas fa-cash-register"></i> Cash Payment Validation</h2>
                    <div class="validation-message">
                        Visit the gym counter and show this QR code or validation code to complete your payment.
                    </div>
                    
                    <div class="validation-details">
                        <div><strong><i class="fas fa-key"></i> Validation Code:</strong></div>
                        <div class="validation-code">${validationCode}</div>
                        <div><strong><i class="fas fa-user"></i> Member:</strong> <span>${paymentData.username}</span></div>
                        <div><strong><i class="fas fa-dumbbell"></i> Plan:</strong> <span>${paymentData.planName}</span></div>
                        <div><strong><i class="fas fa-calendar"></i> Duration:</strong> <span>${paymentData.durationText}</span></div>
                        <div><strong><i class="fas fa-rupee-sign"></i> Amount:</strong> <span>‚Çπ${paymentData.totalAmount}</span></div>
                    </div>

                    ${qrCodeUrl ? `
                    <div class="qr-code-section show" id="qrCodeSection">
                        <h4><i class="fas fa-qrcode"></i> Scan QR Code at Gym Counter</h4>
                        <div class="qr-code-container">
                            <div class="qr-code">
                                <img src="${qrCodeUrl}" alt="Payment QR Code" style="width: 180px; height: 180px;">
                            </div>
                        </div>
                        <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 12px;">
                            <i class="fas fa-info-circle"></i> Admin can scan this QR code for instant validation
                        </p>
                    </div>
                    ` : ''}
                    
                    <div class="validation-timer" id="validationTimer">${formatTime(timeLeft)}</div>
                    
                    <div class="validation-status pending" id="validationStatus">
                        <i class="fas fa-hourglass-half"></i>
                        <span>Waiting for gym admin confirmation...</span>
                    </div>

                    <div style="margin-top: 20px; display: flex; gap: 12px; justify-content: center;">
                        <button onclick="shareValidationCode('${validationCode}')" style="background: var(--info); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-share-alt"></i> Share Code
                        </button>
                        <button onclick="printValidationCode('${validationCode}')" style="background: var(--dark); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Start countdown timer
            startCountdownTimer(timeLeft, validationCode);
        }

        function startCountdownTimer(timeLeft, validationCode) {
            const timer = setInterval(() => {
                timeLeft--;
                const timerElement = document.getElementById('validationTimer');
                
                if (timerElement) {
                    timerElement.textContent = formatTime(timeLeft);
                    
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        updateValidationStatus('expired', 'Validation code expired. Please try again.');
                    }
                }
            }, 1000);
            
            // Store timer reference for cleanup
            window.cashValidationTimer = timer;
        }

        function startMockValidationPolling(validationCode) {
            // For demo purposes - simulate gym admin approval and member registration after 15 seconds
            setTimeout(() => {
                updateValidationStatus('approved', 'Cash payment confirmed by gym admin! Creating member account...');
                
                // Show member registration progress
                setTimeout(() => {
                    updateValidationStatus('approved', '‚úÖ Member registered successfully! Redirecting...');
                    
                    setTimeout(() => {
                        // Simulate successful member registration with full parameters
                        const successUrl = '/frontend/payment-success.html' +
                            '?payment=cash_' + validationCode +
                            '&member=' + encodeURIComponent(paymentData.username) +
                            '&email=' + encodeURIComponent(paymentData.email || 'member@example.com') +
                            '&plan=' + encodeURIComponent(paymentData.planName || 'Membership Plan') +
                            '&amount=' + paymentData.totalAmount +
                            '&duration=' + (paymentData.duration || '1') +
                            '&phone=' + encodeURIComponent(paymentData.phone || '') +
                            '&membershipId=CASH' + validationCode +
                            '&registrationType=cash_payment';
                        
                        console.log('üéâ Redirecting to success page:', successUrl);
                        window.location.href = successUrl;
                    }, 2000);
                }, 2000);
            }, 15000); // Reduced to 15 seconds for better demo experience
            
            // Show demo messages at intervals
            setTimeout(() => {
                showAlert('Demo Mode: QR code contains complete member registration data for gym admin dashboard', 'info');
            }, 3000);
            
            setTimeout(() => {
                showAlert('üì± Gym admin can scan QR code to instantly register member and approve cash payment', 'info');
            }, 8000);
        }

        function shareValidationCode(code) {
            if (navigator.share) {
                navigator.share({
                    title: 'Gym Payment Validation Code',
                    text: `My gym payment validation code: ${code}\nAmount: ‚Çπ${paymentData.totalAmount}\nMember: ${paymentData.username}`,
                    url: window.location.href
                });
            } else {
                // Fallback - copy to clipboard
                navigator.clipboard.writeText(code).then(() => {
                    showAlert('Validation code copied to clipboard!', 'success');
                });
            }
        }

        function printValidationCode(code) {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head><title>Gym Payment Validation</title></head>
                <body style="font-family: Arial, sans-serif; text-align: center; padding: 40px;">
                    <h1>Gym Payment Validation</h1>
                    <div style="font-size: 2rem; font-weight: bold; margin: 20px 0; letter-spacing: 3px;">${code}</div>
                    <p><strong>Member:</strong> ${paymentData.username}</p>
                    <p><strong>Plan:</strong> ${paymentData.planName}</p>
                    <p><strong>Duration:</strong> ${paymentData.durationText}</p>
                    <p><strong>Amount:</strong> ‚Çπ${paymentData.totalAmount}</p>
                    <p style="margin-top: 40px; font-size: 0.9rem; color: #666;">
                        Present this code at the gym counter to complete payment
                    </p>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function startValidationPolling(validationCode) {
            const pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/payment/check-cash-validation/${validationCode}`);
                    const result = await response.json();
                    
                    if (response.ok && result.status === 'approved') {
                        clearInterval(pollInterval);
                        clearInterval(window.cashValidationTimer);
                        updateValidationStatus('approved', 'Payment confirmed! Redirecting...');
                        
                        setTimeout(() => {
                            window.location.href = '/payment/success?payment=' + result.paymentId;
                        }, 2000);
                    } else if (result.status === 'expired') {
                        clearInterval(pollInterval);
                        clearInterval(window.cashValidationTimer);
                        updateValidationStatus('expired', 'Validation code expired. Please try again.');
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 3000); // Poll every 3 seconds
            
            // Store polling reference for cleanup
            window.cashValidationPolling = pollInterval;
        }

        function updateValidationStatus(status, message) {
            const statusElement = document.getElementById('validationStatus');
            if (statusElement) {
                statusElement.className = `validation-status ${status}`;
                
                let icon = 'fa-hourglass-half';
                if (status === 'approved') icon = 'fa-check-circle';
                else if (status === 'expired') icon = 'fa-times-circle';
                
                statusElement.innerHTML = `
                    <i class="fas ${icon}"></i>
                    <span>${message}</span>
                `;
            }
        }

        function formatTime(seconds) {
            if (seconds <= 0) return '00:00';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        async function handleRazorpayPayment(session) {
            // TODO: Implement Razorpay integration
            showAlert('Razorpay integration coming soon! Payment session created successfully.', 'info');
            
            // Mock successful payment for demo
            setTimeout(() => {
                handlePaymentSuccess({
                    paymentId: 'demo_payment_123',
                    gatewayPaymentId: 'razorpay_demo_456'
                });
            }, 2000);
        }

        async function handleUPIPayment(session) {
            showAlert('Opening UPI app...', 'info');
            
            // Create UPI link and QR code
            const upiLink = session.upiLink;
            
            // Try to open UPI app
            if (navigator.userAgent.match(/Android/i) || navigator.userAgent.match(/iPhone/i)) {
                window.location.href = upiLink;
            } else {
                // Show QR code for desktop
                showAlert('Please scan the QR code with your UPI app to complete payment.', 'info');
            }
            
            // Mock successful payment for demo
            setTimeout(() => {
                handlePaymentSuccess({
                    paymentId: 'demo_payment_123',
                    gatewayPaymentId: 'upi_demo_456'
                });
            }, 3000);
        }

        async function handleStripePayment(session) {
            showAlert('Redirecting to Stripe checkout...', 'info');
            
            // TODO: Redirect to Stripe checkout
            // window.location.href = session.url;
            
            // Mock successful payment for demo
            setTimeout(() => {
                handlePaymentSuccess({
                    paymentId: 'demo_payment_123',
                    gatewayPaymentId: 'stripe_demo_456'
                });
            }, 2000);
        }

        async function handlePayPalPayment(session) {
            showAlert('Redirecting to PayPal...', 'info');
            
            // TODO: Redirect to PayPal
            // window.location.href = session.approvalUrl;
            
            // Mock successful payment for demo
            setTimeout(() => {
                handlePaymentSuccess({
                    paymentId: 'demo_payment_123',
                    gatewayPaymentId: 'paypal_demo_456'
                });
            }, 2000);
        }

        async function handlePaymentSuccess(paymentResult) {
            try {
                showAlert('Payment successful! Processing registration...', 'success');
                
                console.log('Processing payment success:', paymentResult);
                console.log('Payment data:', paymentData);

                if (paymentData.type === 'membership') {
                    // Handle membership registration
                    await processMembershipRegistration(paymentResult);
                } else {
                    // Handle legacy QR registration
                    await processQRRegistration(paymentResult);
                }

            } catch (error) {
                console.error('Payment processing error:', error);
                showAlert('Payment processing failed. Please contact support.', 'error');
            }
        }

        async function processMembershipRegistration(paymentResult) {
            try {
                const membershipData = paymentData.membershipData;
                const BASE_URL = `${window.location.protocol}//${window.location.hostname}:5000`;
                
                // Prepare member registration data
                const registrationData = {
                    ...membershipData,
                    paymentStatus: 'paid',
                    paymentMethod: 'Online',
                    paymentId: paymentResult.paymentId,
                    gatewayPaymentId: paymentResult.gatewayPaymentId,
                    paymentSignature: paymentResult.signature,
                    actualAmount: paymentData.totalAmount,
                    registrationDate: new Date().toISOString()
                };

                console.log('Registering member with data:', registrationData);

                // Register member directly to gym admin dashboard
                const response = await fetch(`${BASE_URL}/api/members/register-online`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${paymentData.userToken}`
                    },
                    body: JSON.stringify({
                        gymId: membershipData.gymId,
                        memberName: membershipData.memberName,
                        memberEmail: membershipData.email,
                        memberPhone: membershipData.phone,
                        memberAge: membershipData.age,
                        memberGender: membershipData.gender,
                        memberAddress: membershipData.address || '',
                        paymentMode: 'Online',
                        paymentAmount: paymentData.totalAmount,
                        planSelected: membershipData.planSelected,
                        monthlyPlan: membershipData.monthlyPlan,
                        activityPreference: membershipData.activityPreference || 'General Fitness',
                        paymentStatus: 'paid',
                        paymentId: paymentResult.paymentId,
                        registrationType: 'online_membership',
                        // Force add to avoid duplicate checks for online registration
                        forceAdd: true
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Member registration successful:', result);
                    
                    showAlert('Registration complete! Welcome to the gym!', 'success');
                    
                    // Clear session storage
                    sessionStorage.removeItem('membershipRegistrationData');
                    sessionStorage.removeItem('userToken');
                    
                    // Redirect to success page
                    setTimeout(() => {
                        window.location.href = `/frontend/payment-success.html?member=${result.member.membershipId}&gym=${membershipData.gymName}&plan=${membershipData.planSelected}&amount=${paymentData.totalAmount}`;
                    }, 2000);
                } else {
                    const error = await response.json();
                    console.error('‚ùå Member registration failed:', error);
                    throw new Error(error.message || 'Failed to register member');
                }

            } catch (error) {
                console.error('Error in membership registration:', error);
                showAlert('Registration failed: ' + error.message, 'error');
            }
        }

        async function processQRRegistration(paymentResult) {
            try {
                // Legacy QR registration flow
                const response = await fetch('/api/payment/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        paymentId: paymentResult.paymentId,
                        gatewayPaymentId: paymentResult.gatewayPaymentId,
                        signature: paymentResult.signature
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('Payment verified successfully! Redirecting...', 'success');
                    setTimeout(() => {
                        window.location.href = '/payment/success?payment=' + result.payment.id;
                    }, 2000);
                } else {
                    throw new Error(result.message || 'Payment verification failed');
                }

            } catch (error) {
                console.error('QR registration error:', error);
                showAlert('Payment verification failed. Please contact support.', 'error');
            }
        }

        function showAlert(message, type = 'info') {
            const alertArea = document.getElementById('alertArea');
            
            const iconMap = {
                'success': 'fa-check-circle',
                'error': 'fa-exclamation-triangle',
                'warning': 'fa-exclamation-circle',
                'info': 'fa-info-circle'
            };
            
            alertArea.innerHTML = `
                <div class="alert ${type}">
                    <i class="fas ${iconMap[type]}"></i>
                    ${message}
                </div>
            `;
            
            // Auto-hide info and success alerts after 5 seconds
            if (type === 'info' || type === 'success') {
                setTimeout(() => {
                    alertArea.innerHTML = '';
                }, 5000);
            }
        }

        // Format card number input
        document.getElementById('cardNumber')?.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            e.target.value = formattedValue;
        });

        // Format expiry date input
        document.getElementById('expiryDate')?.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value;
        });

        // CVV input validation
        document.getElementById('cvv')?.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            e.target.value = value.substring(0, 3);
        });

        // Helper function to calculate age from date of birth
        function calculateAge(dateOfBirth) {
            if (!dateOfBirth) return null;
            
            const today = new Date();
            const birthDate = new Date(dateOfBirth);
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            return age;
        }
    </script>
</body>
</html>
